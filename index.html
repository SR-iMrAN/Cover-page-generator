<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DIU Cover Point</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Orbitron:wght@700;900&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<style>
:root{
  --ui-bg:#eef2fb;--ui-surface:#ffffff;--ui-border:#c8d5ee;--ui-accent:#2d54b8;
  --ui-text:#1a2540;--ui-muted:#4e5f80;--ui-ph:#9aabc8;--ui-input-b:#c0ceeb;
  --ui-header:#1a2d62;--ui-sec-bg:#edf1fb;
  --merge-header:#1a1a2e;--merge-header-accent:#7c3aed;
}
*{margin:0;padding:0;box-sizing:border-box;}
html,body{height:100%;}
body{background:var(--ui-bg);color:var(--ui-text);font-family:'Inter',sans-serif;min-height:100vh;}

/* ‚îÄ‚îÄ TOAST SYSTEM ‚îÄ‚îÄ */
#toast-container{position:fixed;top:62px;right:16px;z-index:9999;display:flex;flex-direction:column;gap:8px;pointer-events:none;}
.toast{pointer-events:all;display:flex;align-items:center;gap:10px;padding:12px 16px;border-radius:10px;font-size:13px;font-weight:500;color:#fff;box-shadow:0 6px 24px rgba(0,0,0,0.22);transform:translateX(120%);transition:transform .35s cubic-bezier(.34,1.56,.64,1),opacity .35s;opacity:0;min-width:240px;max-width:340px;line-height:1.4;}
.toast.show{transform:translateX(0);opacity:1;}
.toast.hide{transform:translateX(120%);opacity:0;}
.toast-icon{font-size:18px;flex-shrink:0;}
.toast-body{flex:1;}
.toast-title{font-weight:700;font-size:13px;}
.toast-msg{font-size:11.5px;opacity:.85;margin-top:2px;}
.toast.success{background:linear-gradient(135deg,#16a34a,#0e7230);}
.toast.error{background:linear-gradient(135deg,#dc2626,#991b1b);}
.toast.info{background:linear-gradient(135deg,#2d54b8,#1a3880);}
.toast.warning{background:linear-gradient(135deg,#d97706,#92400e);}
.toast-close{background:none;border:none;color:rgba(255,255,255,0.6);font-size:16px;cursor:pointer;line-height:1;padding:0 0 0 4px;flex-shrink:0;}
.toast-close:hover{color:#fff;}
.toast-progress{position:absolute;bottom:0;left:0;height:3px;background:rgba(255,255,255,0.4);border-radius:0 0 10px 10px;transition:width linear;}

/* ‚îÄ‚îÄ WELCOME BANNER ‚îÄ‚îÄ */
#welcomeBanner{position:fixed;top:0px;left:0;right:0;z-index:600;background:linear-gradient(135deg,#0f172a 0%,#1e293b 50%,#0f2044 100%);border-bottom:2px solid rgba(168,192,255,0.2);box-shadow:0 4px 32px rgba(0,0,0,0.5);transform:translateY(calc(-100% - 60px));transition:transform .5s cubic-bezier(.34,1.2,.64,1);overflow:hidden;}
#welcomeBanner.open{transform:translateY(0);}
.wb-inner{padding:14px 24px 16px;max-width:1200px;margin:0 auto;position:relative;}
.wb-close{position:absolute;top:12px;right:16px;background:rgba(255,255,255,0.1);border:none;color:rgba(255,255,255,0.6);font-size:18px;cursor:pointer;border-radius:6px;width:28px;height:28px;display:flex;align-items:center;justify-content:center;transition:all .15s;}
.wb-close:hover{background:rgba(255,255,255,0.2);color:#fff;}
.wb-title{font-family:'Orbitron',sans-serif;font-size:13px;font-weight:900;letter-spacing:3px;color:#a8c0ff;margin-bottom:8px;}
.wb-title span{color:#4ade80;}
.wb-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:12px;}
@media(max-width:700px){.wb-grid{grid-template-columns:1fr 1fr;}}
@media(max-width:440px){.wb-grid{grid-template-columns:1fr;}}
.wb-feat{background:rgba(255,255,255,0.06);border:1px solid rgba(168,192,255,0.15);border-radius:8px;padding:9px 12px;display:flex;align-items:flex-start;gap:8px;}
.wb-feat-icon{font-size:16px;flex-shrink:0;margin-top:1px;}
.wb-feat-text{font-size:11px;color:rgba(255,255,255,0.75);line-height:1.5;}
.wb-feat-text strong{color:#a8c0ff;display:block;font-size:10.5px;letter-spacing:.3px;}
/* NEW template feature highlight */
.wb-feat.wb-new{border-color:rgba(124,58,237,0.5);background:rgba(124,58,237,0.12);}
.wb-feat.wb-new .wb-feat-text strong{color:#c4b5fd;}
.wb-footer{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;}
.wb-hint{font-size:10.5px;color:rgba(255,255,255,0.4);display:flex;align-items:center;gap:5px;}
.wb-hint a{color:#a8c0ff;text-decoration:underline;cursor:pointer;}
.wb-timer{font-family:'Orbitron',sans-serif;font-size:9px;color:rgba(255,255,255,0.3);letter-spacing:1px;}
.wb-progress{height:2px;background:rgba(255,255,255,0.08);border-radius:2px;margin-top:10px;overflow:hidden;}
.wb-progress-bar{height:100%;background:linear-gradient(90deg,#4ade80,#2d54b8);border-radius:2px;width:100%;transition:width linear;}

/* ‚îÄ‚îÄ CHANGE TEMPLATE BUTTON ‚îÄ‚îÄ */
.change-template-btn{
  display:flex;align-items:center;gap:6px;
  background:linear-gradient(130deg,#7c3aed,#4f46e5);
  border:none;border-radius:7px;padding:6px 12px;
  color:#fff;font-family:'Orbitron',sans-serif;font-size:9px;
  letter-spacing:1.5px;font-weight:700;cursor:pointer;
  transition:all .2s;white-space:nowrap;
  box-shadow:0 2px 10px rgba(124,58,237,0.4);
  position:relative;overflow:hidden;
  text-decoration:none;
}
.change-template-btn::after{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.15),transparent);transition:left .35s;}
.change-template-btn:hover::after{left:100%;}
.change-template-btn:hover{box-shadow:0 4px 18px rgba(124,58,237,0.55);transform:translateY(-1px);}
.change-template-btn .ct-icon{font-size:13px;}
.change-template-btn .ct-new{position:absolute;top:-5px;right:-5px;background:#4ade80;color:#000;font-family:'Inter',sans-serif;font-size:7px;font-weight:800;border-radius:6px;padding:1px 4px;letter-spacing:.5px;}

/* TEMPLATE PICKER MODAL */
.tpl-modal-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.55);z-index:700;align-items:center;justify-content:center;padding:20px;}
.tpl-modal-bg.open{display:flex;}
.tpl-modal{background:#fff;border-radius:14px;width:100%;max-width:520px;box-shadow:0 24px 80px rgba(0,0,0,0.35);overflow:hidden;animation:modalIn .22s ease;}
@keyframes modalIn{from{opacity:0;transform:scale(.95);}to{opacity:1;transform:scale(1);}}
.tpl-modal-head{background:linear-gradient(135deg,#0f172a,#1e293b);padding:18px 22px;display:flex;align-items:center;justify-content:space-between;}
.tpl-modal-head h3{color:#fff;font-family:'Orbitron',sans-serif;font-size:12px;font-weight:900;letter-spacing:2px;}
.tpl-modal-head h3 span{color:#c4b5fd;}
.tpl-modal-close{background:none;border:none;color:rgba(255,255,255,0.5);font-size:22px;cursor:pointer;border-radius:5px;width:28px;height:28px;display:flex;align-items:center;justify-content:center;transition:all .15s;}
.tpl-modal-close:hover{color:#fff;background:rgba(255,255,255,0.1);}
.tpl-modal-body{padding:22px;}
.tpl-modal-sub{font-size:11px;color:var(--ui-muted);margin-bottom:16px;}
.tpl-card{display:flex;align-items:center;gap:16px;padding:16px;border:2px solid var(--ui-border);border-radius:12px;cursor:pointer;transition:all .2s;margin-bottom:12px;background:var(--ui-sec-bg);text-decoration:none;color:inherit;}
.tpl-card:hover{border-color:var(--ui-accent);background:#e8eeff;transform:translateY(-1px);box-shadow:0 6px 20px rgba(45,84,184,0.12);}
.tpl-card.tpl-current{border-color:#4ade80;background:#f0fdf4;cursor:default;pointer-events:none;}
.tpl-card.tpl-new{border-color:#7c3aed;background:#f5f3ff;}
.tpl-card.tpl-new:hover{border-color:#7c3aed;background:#ede9fe;}
.tpl-card-icon{font-size:32px;flex-shrink:0;}
.tpl-card-info{flex:1;}
.tpl-card-title{font-size:14px;font-weight:700;color:var(--ui-text);display:flex;align-items:center;gap:8px;}
.tpl-badge{font-size:9px;padding:2px 8px;border-radius:10px;font-weight:700;letter-spacing:.5px;}
.tpl-badge.current{background:#dcfce7;color:#16a34a;}
.tpl-badge.new{background:linear-gradient(130deg,#7c3aed,#4f46e5);color:#fff;}
.tpl-badge.classic{background:#dbeafe;color:#1d4ed8;}
.tpl-card-desc{font-size:11px;color:var(--ui-muted);margin-top:4px;line-height:1.5;}
.tpl-go-btn{display:flex;align-items:center;justify-content:center;width:32px;height:32px;border-radius:8px;background:var(--ui-accent);color:#fff;font-size:16px;flex-shrink:0;transition:all .2s;}
.tpl-card.tpl-new .tpl-go-btn{background:linear-gradient(130deg,#7c3aed,#4f46e5);}
.tpl-card.tpl-current .tpl-go-btn{background:#16a34a;}

header{background:var(--ui-header);padding:0 20px;height:51px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:300;box-shadow:0 2px 14px rgba(26,45,98,0.22);gap:10px;}
.header-left{display:flex;align-items:center;gap:12px;}
.app-title{font-family:'Orbitron',sans-serif;font-weight:900;font-size:13px;letter-spacing:3px;color:#a8c0ff;white-space:nowrap;}
.app-title span{color:#4ade80;}
.app-subtitle{font-size:9px;color:rgba(255,255,255,0.3);letter-spacing:1px;white-space:nowrap;}
.header-center{display:flex;align-items:center;}
.toggle-wrap{display:flex;border-radius:7px;overflow:hidden;border:1.5px solid rgba(255,255,255,0.2);background:rgba(255,255,255,0.07);}
.tbtn{font-family:'Orbitron',sans-serif;font-size:10px;letter-spacing:2px;font-weight:700;padding:8px 18px;background:none;border:none;color:rgba(255,255,255,0.45);cursor:pointer;transition:all .2s;}
.tbtn.active{background:var(--ui-accent);color:#fff;}
.tbtn:not(.active):hover{color:#fff;}
.tbtn.merge-tab{display:flex;align-items:center;gap:5px;}
.tbtn.merge-tab.active{background:linear-gradient(130deg,#7c3aed,#4f46e5);}
.header-right{display:flex;align-items:center;gap:8px;}
.visitor-badge{display:flex;align-items:center;gap:5px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.15);border-radius:20px;padding:3px 10px 3px 7px;cursor:default;}
.visitor-icon{font-size:12px;}
.visitor-count{font-family:'Orbitron',sans-serif;font-size:9px;color:#a8c0ff;letter-spacing:1px;font-weight:700;}
.dl-count-badge{display:flex;align-items:center;gap:5px;background:rgba(74,222,128,0.12);border:1px solid rgba(74,222,128,0.3);border-radius:20px;padding:3px 10px 3px 7px;cursor:default;}
.dl-count-icon{font-size:12px;}
.dl-count-val{font-family:'Orbitron',sans-serif;font-size:9px;color:#4ade80;letter-spacing:1px;font-weight:700;}
.v-badge{font-size:9px;color:rgba(255,255,255,0.25);letter-spacing:1.5px;font-family:'Orbitron',sans-serif;white-space:nowrap;}
.hamburger{background:none;border:none;cursor:pointer;display:flex;flex-direction:column;justify-content:center;gap:4px;padding:6px;border-radius:6px;transition:background .2s;}
.hamburger:hover{background:rgba(255,255,255,0.1);}
.hamburger span{display:block;width:20px;height:2px;background:rgba(255,255,255,0.7);border-radius:2px;transition:all .3s;}
.hamburger.open span:nth-child(1){transform:translateY(6px) rotate(45deg);}
.hamburger.open span:nth-child(2){opacity:0;}
.hamburger.open span:nth-child(3){transform:translateY(-6px) rotate(-45deg);}
.dropdown-menu{position:fixed;top:51px;right:0;width:280px;background:#1e3060;border-left:1px solid rgba(255,255,255,0.1);border-bottom:1px solid rgba(255,255,255,0.1);border-radius:0 0 0 10px;box-shadow:-4px 4px 24px rgba(0,0,0,0.4);z-index:400;transform:translateX(100%);transition:transform .28s cubic-bezier(.4,0,.2,1);overflow:hidden;}
.dropdown-menu.open{transform:translateX(0);}
.dm-section{padding:14px 18px 8px;font-size:9px;font-weight:700;letter-spacing:2px;color:rgba(255,255,255,0.3);text-transform:uppercase;}
.dm-item{display:flex;align-items:center;gap:12px;padding:12px 18px;cursor:pointer;color:rgba(255,255,255,0.8);font-size:13px;font-weight:500;transition:background .15s;border:none;background:none;width:100%;text-align:left;}
.dm-item:hover{background:rgba(255,255,255,0.08);color:#fff;}
.dm-item .dm-icon{font-size:16px;width:22px;text-align:center;flex-shrink:0;}
.dm-item .dm-desc{font-size:10px;color:rgba(255,255,255,0.4);display:block;margin-top:1px;}
.dm-divider{height:1px;background:rgba(255,255,255,0.08);margin:6px 0;}

/* MODALS */
.modal-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:500;align-items:center;justify-content:center;padding:20px;}
.modal-bg.open{display:flex;}
.modal{background:#fff;border-radius:12px;width:100%;max-width:440px;box-shadow:0 20px 60px rgba(0,0,0,0.3);overflow:hidden;animation:modalIn .22s ease;}
.modal-head{background:var(--ui-header);padding:16px 20px;display:flex;align-items:center;justify-content:space-between;}
.modal-head h3{color:#fff;font-size:14px;font-weight:700;letter-spacing:.5px;}
.modal-close{background:none;border:none;color:rgba(255,255,255,0.6);font-size:20px;cursor:pointer;line-height:1;padding:2px 6px;border-radius:4px;}
.modal-close:hover{color:#fff;background:rgba(255,255,255,0.1);}
.modal-body{padding:22px 20px;}
.dev-card{display:flex;align-items:center;gap:14px;margin-bottom:18px;}
.dev-avatar{width:54px;height:54px;border-radius:50%;background:linear-gradient(135deg,#2d54b8,#4ade80);display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0;}
.dev-name{font-weight:700;font-size:15px;color:var(--ui-text);}
.dev-role{font-size:12px;color:var(--ui-muted);margin-top:2px;}
.dev-links{display:flex;flex-direction:column;gap:8px;}
.dev-link{display:flex;align-items:center;gap:10px;padding:10px 14px;border-radius:8px;background:var(--ui-sec-bg);color:var(--ui-accent);font-size:13px;font-weight:500;text-decoration:none;border:1.5px solid var(--ui-border);transition:all .15s;}
.dev-link:hover{background:var(--ui-accent);color:#fff;border-color:var(--ui-accent);}
.dev-link .dl-icon{font-size:15px;}
.rating-wrap{text-align:center;margin-bottom:16px;}
.stars{display:flex;justify-content:center;gap:8px;margin:14px 0 6px;}
.star{font-size:32px;cursor:pointer;transition:transform .1s;filter:grayscale(1);opacity:.4;}
.star.active{filter:none;opacity:1;transform:scale(1.15);}
.star:hover{transform:scale(1.2);}
.rating-label{font-size:12px;color:var(--ui-muted);min-height:18px;}
.comment-box{width:100%;border:1.5px solid var(--ui-input-b);border-radius:8px;padding:10px 12px;font-family:'Inter',sans-serif;font-size:13px;color:var(--ui-text);resize:vertical;min-height:80px;outline:none;transition:border-color .15s;}
.comment-box:focus{border-color:var(--ui-accent);box-shadow:0 0 0 3px rgba(45,84,184,0.1);}
.comment-label{font-size:11px;font-weight:600;color:var(--ui-muted);letter-spacing:.5px;margin-bottom:6px;display:block;text-transform:uppercase;}
.submit-btn{width:100%;margin-top:14px;padding:11px;background:linear-gradient(130deg,#2d54b8,#1a3880);border:none;border-radius:7px;color:#fff;font-family:'Inter',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;}
.submit-btn:hover{opacity:.9;transform:translateY(-1px);}
.submit-success{text-align:center;padding:10px 0 4px;color:#16a34a;font-weight:600;font-size:13px;display:none;}

/* Choose cover modal */
.choose-cover-modal .modal-body{padding:18px 20px;}
.choose-cover-option{display:flex;align-items:center;gap:14px;padding:14px 16px;border:2px solid var(--ui-border);border-radius:10px;cursor:pointer;transition:all .2s;margin-bottom:10px;background:var(--ui-sec-bg);}
.choose-cover-option:hover{border-color:var(--ui-accent);background:#e8eeff;}
.choose-cover-option.selected{border-color:var(--ui-accent);background:#dce8ff;}
.cco-icon{font-size:26px;flex-shrink:0;}
.cco-info{flex:1;}
.cco-title{font-size:13px;font-weight:700;color:var(--ui-text);}
.cco-count{font-size:11px;color:var(--ui-muted);margin-top:2px;}
.cco-filled{font-size:10px;color:#16a34a;font-weight:600;margin-top:2px;}
.choose-cover-btn{width:100%;margin-top:6px;padding:11px;background:linear-gradient(130deg,#16a34a,#0e7230);border:none;border-radius:7px;color:#fff;font-family:'Inter',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;}
.choose-cover-btn:hover{opacity:.9;transform:translateY(-1px);}

/* MAIN LAYOUT */
.app-layout{display:grid;grid-template-columns:350px 1fr;min-height:calc(100vh - 51px);}
.inp-panel{background:var(--ui-surface);border-right:1.5px solid var(--ui-border);padding:20px 18px 30px;overflow-y:auto;max-height:calc(100vh - 51px);}
.inp-panel::-webkit-scrollbar{width:5px;}
.inp-panel::-webkit-scrollbar-thumb{background:#c0ceeb;border-radius:10px;}
.sec-head{font-size:10px;font-weight:700;letter-spacing:2.5px;color:var(--ui-accent);text-transform:uppercase;padding:7px 10px;margin-bottom:11px;background:var(--ui-sec-bg);border-left:3px solid var(--ui-accent);border-radius:0 5px 5px 0;}
.sec-head-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:11px;}
.sec-head-row .sec-head{margin-bottom:0;flex:1;}
.copy-btn{flex-shrink:0;margin-left:8px;padding:4px 9px;background:#16a34a;border:none;border-radius:5px;color:#fff;font-family:'Inter',sans-serif;font-size:10px;font-weight:600;cursor:pointer;transition:all .2s;white-space:nowrap;box-shadow:0 2px 6px rgba(22,163,74,0.25);}
.copy-btn:hover{background:#0e7230;transform:translateY(-1px);}
.sgap{height:16px;}
.fg{margin-bottom:12px;}
.fg label{display:block;font-size:10.5px;font-weight:600;letter-spacing:1px;color:var(--ui-muted);margin-bottom:4px;text-transform:uppercase;}
.fg input{width:100%;background:#fff;border:1.5px solid var(--ui-input-b);border-radius:6px;color:var(--ui-text);font-family:'Inter',sans-serif;font-size:13.5px;font-weight:500;padding:8px 12px;outline:none;transition:border-color .15s,box-shadow .15s;}
.fg input:focus{border-color:var(--ui-accent);box-shadow:0 0 0 3px rgba(45,84,184,0.1);}
.fg input::placeholder{color:var(--ui-ph);}
.fg input[type="date"]{color-scheme:light;direction:ltr;}
.fg .readonly-field{background:#f0f4fc;color:var(--ui-muted);border-color:#d8e2f4;cursor:default;font-style:italic;}

.optional-toggle{display:flex;align-items:center;gap:7px;margin-bottom:10px;cursor:pointer;padding:6px 10px;border-radius:6px;background:var(--ui-sec-bg);border:1.5px dashed var(--ui-border);transition:all .2s;user-select:none;}
.optional-toggle:hover{border-color:var(--ui-accent);background:#e8eeff;}
.optional-toggle-icon{font-size:11px;color:var(--ui-accent);transition:transform .2s;}
.optional-toggle-icon.open{transform:rotate(90deg);}
.optional-toggle-text{font-size:10.5px;font-weight:600;color:var(--ui-muted);letter-spacing:.5px;flex:1;}
.optional-toggle-badge{font-size:9px;background:var(--ui-accent);color:#fff;border-radius:10px;padding:1px 7px;font-weight:700;letter-spacing:.5px;}
.optional-fields{display:none;padding:2px 0 4px 0;}
.optional-fields.open{display:block;}
.field-enable-row{display:flex;align-items:center;gap:8px;margin-bottom:10px;}
.field-enable-row .fg{flex:1;margin-bottom:0;}
.field-toggle-btn{width:34px;height:20px;border-radius:10px;border:none;cursor:pointer;position:relative;background:#d1d5db;transition:background .2s;flex-shrink:0;margin-top:18px;}
.field-toggle-btn.on{background:var(--ui-accent);}
.field-toggle-btn::after{content:'';position:absolute;top:3px;left:3px;width:14px;height:14px;border-radius:50%;background:#fff;transition:transform .2s;}
.field-toggle-btn.on::after{transform:translateX(14px);}
.fg-optional{opacity:.45;pointer-events:none;filter:grayscale(.5);}
.fg-optional.enabled{opacity:1;pointer-events:all;filter:none;}

.dl-btn{width:100%;padding:13px;background:linear-gradient(130deg,#2d54b8,#1a3880);border:none;border-radius:7px;color:#fff;font-family:'Orbitron',sans-serif;font-size:11px;letter-spacing:2.5px;font-weight:700;cursor:pointer;transition:all .25s;box-shadow:0 4px 18px rgba(45,84,184,0.3);position:relative;overflow:hidden;}
.dl-btn::after{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.12),transparent);transition:left .4s;}
.dl-btn:hover::after{left:100%;}
.dl-btn:hover:not(:disabled){box-shadow:0 6px 26px rgba(45,84,184,0.42);transform:translateY(-1px);}
.dl-btn:disabled{opacity:.4;cursor:not-allowed;transform:none;background:linear-gradient(130deg,#7a8fbc,#4a5f8a);}
.dl-btn.generating{background:linear-gradient(130deg,#7c3aed,#4f46e5);animation:dlPulse 1.2s ease-in-out infinite;}
@keyframes dlPulse{
  0%{box-shadow:0 0 0 0 rgba(124,58,237,0.7),0 4px 18px rgba(124,58,237,0.4);}
  50%{box-shadow:0 0 0 12px rgba(124,58,237,0),0 4px 28px rgba(124,58,237,0.6);}
  100%{box-shadow:0 0 0 0 rgba(124,58,237,0),0 4px 18px rgba(124,58,237,0.4);}
}
.dl-btn.success{background:linear-gradient(130deg,#16a34a,#0e7230);animation:dlSuccess .4s ease forwards;}
@keyframes dlSuccess{0%{transform:scale(1);}30%{transform:scale(1.06);}60%{transform:scale(0.98);}100%{transform:scale(1);}}

.dl-btn-wrap{margin-bottom:10px;}
.dl-btn-tooltip{display:none;position:absolute;bottom:calc(100% + 8px);left:50%;transform:translateX(-50%);background:#1a2540;color:#fff;font-family:'Inter',sans-serif;font-size:11px;font-weight:500;padding:7px 12px;border-radius:6px;white-space:nowrap;letter-spacing:0;pointer-events:none;box-shadow:0 4px 14px rgba(0,0,0,0.25);z-index:10;}
.dl-btn-tooltip::after{content:'';position:absolute;top:100%;left:50%;transform:translateX(-50%);border:5px solid transparent;border-top-color:#1a2540;}
.dl-btn-wrap:hover .dl-btn-tooltip{display:block;}

.reset-bar{display:flex;align-items:center;gap:8px;margin-top:10px;}
.reset-btn{flex:1;padding:8px 12px;background:#fee2e2;border:1.5px solid #fca5a5;border-radius:6px;color:#dc2626;font-family:'Inter',sans-serif;font-size:11px;font-weight:700;cursor:pointer;transition:all .2s;letter-spacing:.5px;display:flex;align-items:center;justify-content:center;gap:5px;}
.reset-btn:hover{background:#dc2626;color:#fff;border-color:#dc2626;}
.undo-btn{flex:1;padding:8px 12px;background:#fef3c7;border:1.5px solid #fcd34d;border-radius:6px;color:#92400e;font-family:'Inter',sans-serif;font-size:11px;font-weight:700;cursor:pointer;transition:all .2s;letter-spacing:.5px;display:flex;align-items:center;justify-content:center;gap:5px;position:relative;overflow:hidden;}
.undo-btn:hover:not([disabled]){background:#f59e0b;color:#fff;border-color:#f59e0b;}
.undo-btn[disabled]{opacity:.35;cursor:not-allowed;}
.undo-timer{position:absolute;bottom:0;left:0;height:3px;background:#f59e0b;border-radius:0 0 0 4px;}

.dl-particles{position:fixed;pointer-events:none;z-index:9999;top:0;left:0;width:100%;height:100%;}
.dl-particle{position:absolute;border-radius:50%;animation:particleBurst 0.9s ease-out forwards;}
@keyframes particleBurst{0%{opacity:1;transform:translate(0,0) scale(1);}100%{opacity:0;transform:translate(var(--tx),var(--ty)) scale(0);}}

.mode-panel{display:none;}
.mode-panel.active{display:block;}
.prev-panel{background:#3a3a3a;display:flex;flex-direction:column;align-items:center;padding:28px 20px 40px;overflow-y:auto;max-height:calc(100vh - 51px);}
.prev-label{color:rgba(255,255,255,0.38);font-size:9px;letter-spacing:2.5px;margin-bottom:14px;font-family:'Orbitron',sans-serif;}
.bottom-label{margin-top:20px;opacity:0.35;}

/* COVER PAGE */
.cv-page{width:210mm;min-height:296mm;background:#ffffff;position:relative;}
#cover-page{box-shadow:0 16px 60px rgba(0,0,0,0.55);margin:0 auto;}
.cv-border{position:absolute;top:16px;left:16px;right:19px;bottom:16px;border:1.5px solid #444;pointer-events:none;z-index:10;}
.cv-wm{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:420px;height:420px;background-image:url('img/watermark.jpg');background-size:contain;background-repeat:no-repeat;background-position:center;opacity:0.075;z-index:1;pointer-events:none;}
.cv-body{position:relative;z-index:5;padding:36px 55px 40px 55px;min-height:1018px;display:flex;flex-direction:column;font-family:'Calibri','Carlito',Arial,sans-serif;color:#000;}
.cv-logo{display:flex;align-items:center;justify-content:center;margin-bottom:10px;padding-top:20px;}
.cv-logo img{height:120px;width:auto;display:block;}
.cv-title{font-family:'Nirmala UI','Segoe UI','Trebuchet MS',Arial,sans-serif;font-size:27px;font-weight:700;text-decoration:underline;text-align:center;color:#000;margin:0 0 20px 0;}
.cv-row{display:block;margin-bottom:9px;line-height:1.5;}
.cv-lbl{font-family:'Calibri','Carlito',Arial,sans-serif;font-size:21px;font-weight:700;color:#000;display:inline;}
.cv-val{font-family:'Calibri','Carlito',Arial,sans-serif;font-size:21px;font-weight:400;color:#000;display:inline;}
.cv-sec{font-family:'Calibri','Carlito',Arial,sans-serif;font-size:21px;font-weight:700;color:#000;margin:18px 0 6px 0;}
.cv-ib{padding-left:110px;}
.cv-ir{display:block;margin-bottom:10px;margin-top:10px;line-height:1.5;}
.cv-il{font-family:'Calibri','Carlito',Arial,sans-serif;font-size:19px;font-weight:400;color:#000;display:inline;}
.cv-iv{font-family:'Calibri','Carlito',Arial,sans-serif;font-size:21px;font-weight:400;color:#000;display:inline;}
.cv-iv-name{font-size:23px!important;font-weight:400!important;position:relative;top:1px;}
.cv-uline{font-family:'Calibri','Carlito',Arial,sans-serif;font-size:20px;color:#000;margin-bottom:5px;padding-left:0;}
.cv-date-row{display:block;margin-top:12px;margin-bottom:6px;line-height:1.5;}
.cv-date-row .cv-lbl u{text-decoration:underline;}
.cv-date-row .cv-val{font-size:22px;}

/* MERGE */
.merge-view{display:none;width:100%;min-height:calc(100vh - 51px);background:var(--ui-bg);flex-direction:column;overflow-y:auto;}
.merge-view.active{display:flex;}
.merge-topbar{background:linear-gradient(135deg,#064e3b 0%,#073935 50%,#14b8a6 100%);padding:14px 28px;display:flex;align-items:center;justify-content:space-between;gap:14px;flex-wrap:wrap;border-bottom:2px solid rgba(20,184,166,0.6);flex-shrink:0;box-shadow:0 2px 20px rgba(0,0,0,0.4);}
.merge-topbar-left{display:flex;flex-direction:column;}
.merge-topbar-title{font-family:'Orbitron',sans-serif;font-size:12px;font-weight:900;letter-spacing:3px;color:#c4b5fd;}
.merge-topbar-title span{color:#a78bfa;}
.merge-topbar-desc{font-size:11px;color:rgba(196,181,253,0.45);margin-top:3px;letter-spacing:.5px;}
.merge-steps{display:flex;align-items:center;gap:0;background:rgba(255,255,255,0.06);border:1px solid rgba(124,58,237,0.3);border-radius:8px;overflow:hidden;}
.merge-step{display:flex;align-items:center;gap:6px;padding:7px 14px;font-family:'Orbitron',sans-serif;font-size:9px;letter-spacing:1.5px;font-weight:700;color:rgba(196,181,253,0.4);position:relative;}
.merge-step:not(:last-child)::after{content:'‚Ä∫';position:absolute;right:-1px;color:rgba(196,181,253,0.2);font-size:14px;z-index:1;}
.merge-step .ms-num{width:18px;height:18px;border-radius:50%;border:1.5px solid rgba(196,181,253,0.25);display:flex;align-items:center;justify-content:center;font-size:9px;flex-shrink:0;}
.merge-step.done{color:#a78bfa;}
.merge-step.done .ms-num{background:#7c3aed;border-color:#7c3aed;color:#fff;}
.merge-step.active-step{color:#c4b5fd;}
.merge-step.active-step .ms-num{background:linear-gradient(135deg,#7c3aed,#4f46e5);border-color:#7c3aed;color:#fff;}
.merge-topbar-right{display:flex;align-items:center;gap:10px;}
.merge-dropzone-wrap{padding:20px 28px 0;flex-shrink:0;}
.merge-dropzone{border:2.5px dashed #b0c2e8;border-radius:14px;background:#f4f7fd;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:28px 20px;cursor:pointer;transition:all .2s;text-align:center;position:relative;}
.merge-dropzone.over{border-color:#7c3aed;background:#f3f0ff;box-shadow:0 0 0 4px rgba(124,58,237,0.12);}
.merge-dropzone input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;}
.dz-icon{font-size:34px;margin-bottom:8px;}
.dz-text{font-size:13px;font-weight:600;color:var(--ui-muted);}
.dz-sub{font-size:11px;color:var(--ui-ph);margin-top:3px;}
.merge-cards-wrap{padding:20px 28px;flex:1;}
.merge-cards-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;gap:10px;flex-wrap:wrap;}
.merge-cards-title{font-size:10px;font-weight:700;letter-spacing:2px;color:var(--ui-accent);text-transform:uppercase;}
.merge-cards-count{font-size:10px;color:var(--ui-muted);background:var(--ui-sec-bg);border:1px solid var(--ui-border);border-radius:20px;padding:2px 10px;}
.clear-btn{padding:4px 10px;background:#fee2e2;border:1px solid #fca5a5;border-radius:5px;color:#dc2626;font-size:10px;font-weight:600;cursor:pointer;transition:all .15s;font-family:'Inter',sans-serif;}
.clear-btn:hover{background:#dc2626;color:#fff;}
.merge-cards{display:flex;flex-wrap:wrap;gap:16px;min-height:60px;align-content:flex-start;}
.pdf-card{width:145px;background:#fff;border:2px solid var(--ui-border);border-radius:12px;overflow:hidden;cursor:grab;transition:box-shadow .2s,transform .2s,border-color .2s;position:relative;user-select:none;flex-shrink:0;}
.pdf-card:hover{box-shadow:0 8px 28px rgba(45,84,184,0.15);border-color:#93aee8;}
.pdf-card.dragging{opacity:.45;transform:scale(.96);cursor:grabbing;}
.pdf-card.drag-over{border-color:#7c3aed;box-shadow:0 0 0 3px rgba(124,58,237,0.22);transform:scale(1.02);}
.pdf-card.is-cover{border-color:#4ade80;}
.card-badge{position:absolute;top:6px;left:6px;font-size:8px;font-weight:700;letter-spacing:1px;text-transform:uppercase;background:var(--ui-accent);color:#fff;border-radius:4px;padding:2px 7px;z-index:5;}
.pdf-card.is-cover .card-badge{background:#16a34a;}
.card-remove{position:absolute;top:5px;right:5px;width:20px;height:20px;background:rgba(220,38,38,0.85);border:none;border-radius:50%;color:#fff;font-size:13px;line-height:1;cursor:pointer;display:flex;align-items:center;justify-content:center;z-index:5;transition:background .15s;}
.card-remove:hover{background:#dc2626;}
.card-thumb{width:100%;height:112px;background:#f0f4fc;display:flex;align-items:center;justify-content:center;overflow:hidden;}
.card-thumb canvas{width:100%!important;height:100%!important;object-fit:contain;}
.card-thumb-placeholder{font-size:30px;color:#b0c2e8;}
.card-info{padding:8px 10px 4px;}
.card-name{font-size:10px;font-weight:600;color:var(--ui-text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.card-meta{display:flex;align-items:center;justify-content:space-between;margin-top:3px;}
.card-pages{font-size:9px;color:var(--ui-muted);}
.card-size{font-size:9px;color:var(--ui-ph);background:var(--ui-sec-bg);border-radius:3px;padding:1px 5px;font-weight:600;}
.card-arrows{display:flex;justify-content:center;gap:5px;padding:4px 8px 8px;}
.arr-btn{flex:1;padding:4px 0;background:var(--ui-sec-bg);border:1px solid var(--ui-border);border-radius:5px;font-size:10px;cursor:pointer;transition:background .15s;color:var(--ui-accent);font-weight:700;}
.arr-btn:hover:not(:disabled){background:var(--ui-accent);color:#fff;border-color:var(--ui-accent);}
.arr-btn:disabled{opacity:.28;cursor:default;}
.merge-bottombar{background:var(--ui-surface);border-top:1.5px solid var(--ui-border);padding:14px 28px;display:flex;align-items:center;justify-content:space-between;gap:14px;flex-wrap:wrap;flex-shrink:0;}
.merge-info{font-size:12px;color:var(--ui-muted);}
.merge-info strong{color:var(--ui-accent);}
.merge-dl-btn{padding:12px 26px;background:linear-gradient(130deg,#7c3aed,#4f46e5);border:none;border-radius:8px;color:#fff;font-family:'Orbitron',sans-serif;font-size:10px;letter-spacing:2px;font-weight:700;cursor:pointer;transition:all .25s;box-shadow:0 4px 18px rgba(124,58,237,0.35);position:relative;overflow:hidden;white-space:nowrap;}
.merge-dl-btn::after{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.15),transparent);transition:left .4s;}
.merge-dl-btn:hover::after{left:100%;}
.merge-dl-btn:hover:not(:disabled){box-shadow:0 6px 26px rgba(124,58,237,0.5);transform:translateY(-1px);}
.merge-dl-btn:disabled{opacity:.38;cursor:not-allowed;transform:none;}
.merge-dl-btn.generating{animation:dlPulse 1.2s ease-in-out infinite;}
.merge-dl-btn.success{background:linear-gradient(130deg,#16a34a,#0e7230);animation:dlSuccess .4s ease forwards;}
.merge-progress-wrap{padding:0 28px 10px;flex-shrink:0;}
.merge-progress{height:4px;background:rgba(124,58,237,0.12);border-radius:4px;overflow:hidden;display:none;}
.merge-progress.show{display:block;}
.merge-progress-bar{height:100%;background:linear-gradient(90deg,#7c3aed,#4ade80);border-radius:4px;width:0%;transition:width .3s;}
.cover-note{background:linear-gradient(135deg,#f0fdf4,#dcfce7);border:1px solid #86efac;border-radius:8px;padding:10px 14px;font-size:11px;color:#166534;margin-bottom:14px;display:flex;align-items:flex-start;gap:8px;}
.merge-empty{text-align:center;padding:48px 20px;color:var(--ui-ph);width:100%;}
.merge-empty-icon{font-size:50px;margin-bottom:12px;opacity:.35;}
.merge-empty-text{font-size:13px;font-weight:600;}
.merge-empty-sub{font-size:11px;margin-top:5px;}
.drag-hint{font-size:10px;color:var(--ui-ph);display:flex;align-items:center;gap:5px;}
.add-cover-btn{padding:10px 18px;background:linear-gradient(130deg,#7c3aed,#4f46e5);border:none;border-radius:7px;color:#fff;font-family:'Orbitron',sans-serif;font-size:9px;letter-spacing:1.5px;font-weight:700;cursor:pointer;transition:all .2s;box-shadow:0 3px 12px rgba(124,58,237,0.3);white-space:nowrap;}
.add-cover-btn:hover:not(:disabled){transform:translateY(-1px);box-shadow:0 5px 18px rgba(124,58,237,0.4);}
.add-cover-btn:disabled{opacity:.5;cursor:not-allowed;}

/* MOBILE */
.mobile-tab-bar{display:none;position:fixed;bottom:0;left:0;right:0;background:#1a2d62;border-top:1.5px solid rgba(255,255,255,0.12);z-index:200;padding:0;box-shadow:0 -4px 20px rgba(0,0,0,0.3);}
.mob-tabs{display:flex;width:100%;}
.mob-tab{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:10px 6px 12px;background:none;border:none;cursor:pointer;color:rgba(255,255,255,0.4);font-family:'Orbitron',sans-serif;font-size:7px;letter-spacing:1px;font-weight:700;transition:all .2s;gap:4px;position:relative;}
.mob-tab .mt-icon{font-size:18px;line-height:1;}
.mob-tab.active{color:#fff;}
.mob-tab.active::before{content:'';position:absolute;top:0;left:20%;right:20%;height:2px;background:var(--ui-accent);border-radius:0 0 3px 3px;}
.mob-tab:nth-child(3).active::before{background:#7c3aed;}
.mob-tab:nth-child(3){color:rgba(196,181,253,0.5);}
.mob-tab:nth-child(3).active{color:#c4b5fd;}

@media(max-width:940px){
  .app-layout{grid-template-columns:1fr;}
  .inp-panel{max-height:none;border-right:none;border-bottom:1.5px solid var(--ui-border);}
  .prev-panel{max-height:none;padding:20px 10px 40px;}
  #cover-page{width:100%;max-width:720px;min-height:0;}
  #cover-page .cv-body{min-height:0;}
}
@media(max-width:700px){
  .header-center{display:none;}
  .mobile-tab-bar{display:block;}
  .app-layout{padding-bottom:64px;}
  .merge-view.active{padding-bottom:64px;}
  .app-subtitle{display:none;}
  .change-template-btn .ct-text{display:none;}
  .change-template-btn{padding:6px 10px;}
  .visitor-badge{padding:2px 6px;border-radius:12px;}
  .visitor-icon{font-size:10px;}
  .visitor-count{font-size:8px;letter-spacing:.5px;}
  .dl-count-badge{padding:2px 6px;}
  .dl-count-icon{font-size:10px;}
  .dl-count-val{font-size:8px;letter-spacing:.5px;}
  .merge-topbar,.merge-dropzone-wrap,.merge-cards-wrap,.merge-bottombar,.merge-progress-wrap{padding-left:14px;padding-right:14px;}
  .merge-steps{display:none;}
}
@media(max-width:580px){
  header{padding:0 14px;}
  .app-title{font-size:11px;letter-spacing:2px;}
  .inp-panel{padding:14px 12px 30px;}
  #cover-page .cv-body{padding:24px 26px;}
  #cover-page .cv-logo img{height:80px;}
  #cover-page .cv-title{font-size:18px;}
  #cover-page .cv-lbl,#cover-page .cv-val{font-size:13px!important;}
  #cover-page .cv-il,#cover-page .cv-iv,#cover-page .cv-uline{font-size:12px!important;}
  #cover-page .cv-iv-name{font-size:14px!important;top:1px;}
  #cover-page .cv-sec{font-size:14px!important;}
  #cover-page .cv-ib{padding-left:26px;}
  #cover-page .cv-date-row .cv-val{font-size:13px!important;}
  .dropdown-menu{width:100%;}
  .pdf-card{width:128px;}
  .card-thumb{height:96px;}
  .merge-topbar{flex-direction:column;align-items:flex-start;gap:10px;}
  .merge-topbar-right{width:100%;}
  .add-cover-btn{width:100%;text-align:center;}
  .merge-bottombar{flex-direction:column;align-items:stretch;}
  .merge-dl-btn{width:100%;text-align:center;}
}
@media(max-width:400px){
  #cover-page .cv-body{padding:18px;}
  #cover-page .cv-lbl,#cover-page .cv-val{font-size:11px!important;}
  #cover-page .cv-il,#cover-page .cv-iv,#cover-page .cv-uline{font-size:11px!important;}
  #cover-page .cv-iv-name{font-size:12px!important;top:1px;}
  #cover-page .cv-sec{font-size:12px!important;}
  #cover-page .cv-title{font-size:15px;}
}
@keyframes spin{from{transform:rotate(0deg);}to{transform:rotate(360deg);}}
</style>
</head>
<body>

<div id="toast-container"></div>

<!-- WELCOME BANNER -->
<div id="welcomeBanner">
  <div class="wb-inner">
    <button class="wb-close" onclick="closeWelcome()" title="Close">√ó</button>
    <div class="wb-title">Welcome to DIU <span>Cover</span> Point ‚ú®</div>
    <div class="wb-grid">
      <div class="wb-feat"><span class="wb-feat-icon">üìÑ</span><div class="wb-feat-text"><strong>Assignment & Lab Covers</strong>Fill in your info and get a professional DIU cover page PDF instantly.</div></div>
      <div class="wb-feat wb-new"><span class="wb-feat-icon">üÜï</span><div class="wb-feat-text"><strong>Lab Assignment Report Template</strong>New! Full rubric table template for other depts. Click "Change Template" in the header to access it.</div></div>
      <div class="wb-feat"><span class="wb-feat-icon">‚äï</span><div class="wb-feat-text"><strong>Merge PDF Tool</strong>Combine your cover page with any PDF ‚Äî drag to reorder, one-click download.</div></div>
      <div class="wb-feat"><span class="wb-feat-icon">‚ú®</span><div class="wb-feat-text"><strong>Optional Fields</strong>Expand optional fields like Designation & Group No to add more detail.</div></div>
      <div class="wb-feat"><span class="wb-feat-icon">‚ö°</span><div class="wb-feat-text"><strong>Copy from Assignment</strong>In Lab Report, instantly copy teacher & student info from your assignment.</div></div>
      <div class="wb-feat"><span class="wb-feat-icon">‚Ü©</span><div class="wb-feat-text"><strong>Undo Reset</strong>Accidentally cleared fields? Undo within 15 seconds to restore everything.</div></div>
      <div class="wb-feat"><span class="wb-feat-icon">üåê</span><div class="wb-feat-text"><strong>Download Issues?</strong>If PDF doesn't download, try Chrome or Firefox instead of Messenger browser.</div></div>
    </div>
    <div class="wb-footer">
      <div class="wb-hint">‚ö†Ô∏è Problems? <a onclick="openModal('devModal');closeWelcome()">Contact the developer</a></div>
      <div class="wb-timer" id="wbTimer">Auto-closing in <span id="wbSec">8</span>s</div>
    </div>
    <div class="wb-progress"><div class="wb-progress-bar" id="wbBar"></div></div>
  </div>
</div>

<!-- TEMPLATE PICKER MODAL -->
<div class="tpl-modal-bg" id="tplModal" onclick="closeTplBg(event)">
  <div class="tpl-modal">
    <div class="tpl-modal-head">
      <h3>üé® CHANGE <span>TEMPLATE</span></h3>
      <button class="tpl-modal-close" onclick="closeModal('tplModal')">√ó</button>
    </div>
    <div class="modal-body" style="padding:22px;">
      <div class="tpl-modal-sub">Choose the cover page format that matches your department or assignment type.</div>

      <!-- Current template (DIU standard) -->
      <div class="tpl-card tpl-current">
        <div class="tpl-card-icon">üìÑ</div>
        <div class="tpl-card-info">
          <div class="tpl-card-title">
            DIU Standard Cover
            <span class="tpl-badge current">‚óè CURRENT</span>
            <span class="tpl-badge classic">Classic</span>
          </div>
          <div class="tpl-card-desc">Standard DIU assignment & lab report cover with logo, submitted to/by sections. Works for most CSE courses.</div>
        </div>
        <div class="tpl-go-btn">‚úì</div>
      </div>

      <!-- New template -->
      <a class="tpl-card tpl-new" href="template-lab-assignment.html">
        <div class="tpl-card-icon">üìä</div>
        <div class="tpl-card-info">
          <div class="tpl-card-title">
            Lab Assignment Report
            <span class="tpl-badge new">‚ú¶ NEW</span>
          </div>
          <div class="tpl-card-desc">Full rubric table (Clarity, Content Quality, Spelling, Organization) with customizable page title dropdown. Designed to match the official DIU Lab Assignment Report format exactly.</div>
        </div>
        <div class="tpl-go-btn">‚Üí</div>
      </a>

      <div style="font-size:10px;color:var(--ui-ph);text-align:center;margin-top:4px;">More templates coming soon ¬∑ <span style="color:var(--ui-accent);cursor:pointer;" onclick="openModal('ratingModal');closeModal('tplModal')">Suggest a template ‚Üí</span></div>
    </div>
  </div>
</div>

<header>
  <div class="header-left">
    <div>
      <div class="app-title">DIU <span>COVER</span> POINT</div>
      <div class="app-subtitle">COVER PAGE GENERATOR</div>
    </div>
    <!-- CHANGE TEMPLATE BUTTON -->
    <button class="change-template-btn" onclick="openModal('tplModal')" title="Switch to another cover template">
      <span class="ct-icon">üé®</span>
      <span class="ct-text">CHANGE TEMPLATE</span>
      <span class="ct-new">NEW</span>
    </button>
  </div>
  <div class="header-center">
    <div class="toggle-wrap">
      <button class="tbtn active" id="btn-a" onclick="setMode('assignment')">ASSIGNMENT</button>
      <button class="tbtn" id="btn-l" onclick="setMode('lab')">LAB REPORT</button>
      <button class="tbtn merge-tab" id="btn-m" onclick="setMode('merge')">‚äï MERGE PDF</button>
    </div>
  </div>
  <div class="header-right">
    <div class="dl-count-badge" title="Total downloads">
      <span class="dl-count-icon">‚¨á</span>
      <span class="dl-count-val" id="dlCount">0</span>
    </div>
    <div class="visitor-badge" title="Total page loads">
      <span class="visitor-icon">üëÅ</span>
      <span class="visitor-count" id="visitorCount">0</span>
    </div>
    <span class="v-badge">v3.0</span>
    <button class="hamburger" id="hamburgerBtn" onclick="toggleMenu()" aria-label="Menu">
      <span></span><span></span><span></span>
    </button>
  </div>
</header>

<!-- DROPDOWN -->
<div class="dropdown-menu" id="dropdownMenu">
  <div class="dm-section">Navigation</div>
  <button class="dm-item" onclick="openModal('tplModal');closeMenu()">
    <span class="dm-icon">üé®</span>
    <div><div>Change Template <span style="font-size:9px;background:linear-gradient(130deg,#7c3aed,#4f46e5);color:#fff;border-radius:4px;padding:1px 5px;margin-left:4px;font-weight:700;">NEW</span></div><span class="dm-desc">Switch to Lab Assignment Report template</span></div>
  </button>
  <div class="dm-divider"></div>
  <button class="dm-item" onclick="openModal('devModal')">
    <span class="dm-icon">üë®‚Äçüíª</span>
    <div><div>Developer Info</div><span class="dm-desc">About the creator &amp; links</span></div>
  </button>
  <div class="dm-divider"></div>
  <button class="dm-item" onclick="openModal('ratingModal')">
    <span class="dm-icon">‚≠ê</span>
    <div><div>Comment &amp; Rating</div><span class="dm-desc">Share your feedback</span></div>
  </button>
  <div class="dm-divider"></div>
  <div class="dm-section" style="display:none" id="mobileModeSection">Switch Mode</div>
  <button class="dm-item" id="mobileToggleBtn" style="display:none" onclick="toggleModeFromMenu()">
    <span class="dm-icon">üîÑ</span>
    <div><div id="mobileToggleLabel">Switch to Lab Report</div><span class="dm-desc">Toggle assignment / lab report</span></div>
  </button>
</div>

<!-- MODALS -->
<div class="modal-bg" id="devModal" onclick="closeBg(event,'devModal')">
  <div class="modal">
    <div class="modal-head"><h3>üë®‚Äçüíª Developer Info</h3><button class="modal-close" onclick="closeModal('devModal')">√ó</button></div>
    <div class="modal-body">
      <div class="dev-card">
        <div class="dev-avatar">üßë‚Äçüíª</div>
        <div><div class="dev-name">Sifatur Rahman Imran</div><div class="dev-role">Full Stack Developer ¬∑ DIU Student</div></div>
      </div>
      <div class="dev-links">
        <a class="dev-link" href="https://sr-imran.github.io/sri/" target="_blank"><span class="dl-icon">üåê</span> Portfolio Website</a>
        <a class="dev-link" href="https://github.com/SR-iMrAN?tab=repositories" target="_blank"><span class="dl-icon">üêô</span> GitHub Profile</a>
        <a class="dev-link" href="https://www.linkedin.com/in/s-r-imran/" target="_blank"><span class="dl-icon">üíº</span> LinkedIn</a>
        <a class="dev-link" href="mailto:srimran423@gmail.com"><span class="dl-icon">‚úâÔ∏è</span> Contact via Email</a>
      </div>
    </div>
  </div>
</div>

<div class="modal-bg" id="ratingModal" onclick="closeBg(event,'ratingModal')">
  <div class="modal">
    <div class="modal-head"><h3>‚≠ê Comment &amp; Rating</h3><button class="modal-close" onclick="closeModal('ratingModal')">√ó</button></div>
    <div class="modal-body">
      <div class="rating-wrap">
        <div style="font-size:14px;font-weight:600;color:var(--ui-text);">How would you rate DIU Cover Point?</div>
        <div class="stars" id="stars">
          <span class="star" data-v="1" onclick="setRating(1)">‚òÖ</span>
          <span class="star" data-v="2" onclick="setRating(2)">‚òÖ</span>
          <span class="star" data-v="3" onclick="setRating(3)">‚òÖ</span>
          <span class="star" data-v="4" onclick="setRating(4)">‚òÖ</span>
          <span class="star" data-v="5" onclick="setRating(5)">‚òÖ</span>
        </div>
        <div class="rating-label" id="ratingLabel">Click a star to rate</div>
      </div>
      <label class="comment-label">Your Comment</label>
      <textarea class="comment-box" id="commentBox" placeholder="Share your thoughts, suggestions, or feedback..."></textarea>
      <button class="submit-btn" onclick="submitRating()">Submit Feedback</button>
      <div class="submit-success" id="submitSuccess">‚úÖ Thank you for your feedback!</div>
    </div>
  </div>
</div>

<!-- Choose cover modal -->
<div class="modal-bg" id="chooseCoverModal" onclick="closeBg(event,'chooseCoverModal')">
  <div class="modal choose-cover-modal">
    <div class="modal-head"><h3>üìã Choose Cover Page</h3><button class="modal-close" onclick="closeModal('chooseCoverModal')">√ó</button></div>
    <div class="modal-body">
      <p style="font-size:12px;color:var(--ui-muted);margin-bottom:16px;">Both covers have filled fields. Which one would you like to add to the merge queue?</p>
      <div class="choose-cover-option" id="cco-assignment" onclick="selectCoverChoice('assignment')">
        <div class="cco-icon">üìÑ</div>
        <div class="cco-info">
          <div class="cco-title">Assignment Cover</div>
          <div class="cco-count" id="cco-a-count">0 fields filled</div>
          <div class="cco-filled" id="cco-a-fields"></div>
        </div>
      </div>
      <div class="choose-cover-option" id="cco-lab" onclick="selectCoverChoice('lab')">
        <div class="cco-icon">üî¨</div>
        <div class="cco-info">
          <div class="cco-title">Lab Report Cover</div>
          <div class="cco-count" id="cco-l-count">0 fields filled</div>
          <div class="cco-filled" id="cco-l-fields"></div>
        </div>
      </div>
      <button class="choose-cover-btn" onclick="confirmCoverChoice()">Add Selected Cover</button>
    </div>
  </div>
</div>

<!-- MAIN LAYOUT -->
<div class="app-layout" id="mainLayout">
  <div class="inp-panel">
    <!-- ASSIGNMENT PANEL -->
    <div class="mode-panel active" id="panel-assignment">
      <div class="sec-head">üìÑ Document Info</div>
      <div class="fg"><label>Topic Name</label><input type="text" id="a_topicName" placeholder="e.g. SQL SELECT, Query and Sub Query" oninput="render()"></div>
      <div class="optional-toggle" onclick="toggleOptional('a_optional_doc')" id="opt-tog-a-doc">
        <span class="optional-toggle-icon" id="opt-icon-a-doc">‚ñ∂</span>
        <span class="optional-toggle-text">Add Assignment No (optional)</span>
        <span class="optional-toggle-badge">+1</span>
      </div>
      <div class="optional-fields" id="a_optional_doc">
        <div class="field-enable-row">
          <div class="fg fg-optional" id="fg-a_assignmentNo">
            <label>Assignment No</label>
            <input type="text" id="a_assignmentNo" placeholder="e.g. 01" oninput="render()" disabled>
          </div>
          <button class="field-toggle-btn" id="toggle-a_assignmentNo" onclick="toggleField('a_assignmentNo')" title="Enable/Disable"></button>
        </div>
      </div>
      <div class="fg"><label>Course Code</label><input type="text" id="a_courseCode" placeholder="e.g. CSE311" oninput="render()"></div>
      <div class="fg"><label>Course Title</label><input type="text" id="a_courseTitle" placeholder="e.g. Database Management System" oninput="render()"></div>
      <div class="sgap"></div>
      <div class="sec-head">üë®‚Äçüè´ Submitted To</div>
      <div class="fg"><label>Teacher Name</label><input type="text" id="a_tName" placeholder="e.g. Ada Lovelace, Alan Turing" oninput="render()"></div>
      <div class="optional-toggle" onclick="toggleOptional('a_optional_teacher')" id="opt-tog-a-teacher">
        <span class="optional-toggle-icon" id="opt-icon-a-teacher">‚ñ∂</span>
        <span class="optional-toggle-text">Add Teacher Designation (optional)</span>
        <span class="optional-toggle-badge">+1</span>
      </div>
      <div class="optional-fields" id="a_optional_teacher">
        <div class="field-enable-row">
          <div class="fg fg-optional" id="fg-a_tDesignation">
            <label>Teacher Designation</label>
            <input type="text" id="a_tDesignation" placeholder="e.g. Lecturer, Asst. Professor" oninput="render()" disabled>
          </div>
          <button class="field-toggle-btn" id="toggle-a_tDesignation" onclick="toggleField('a_tDesignation')" title="Enable/Disable"></button>
        </div>
      </div>
      <div class="fg"><label>Department</label><input type="text" id="a_tDept" placeholder="e.g. CSE" oninput="render()"></div>
      <div class="fg"><label>University (Fixed)</label><input class="readonly-field" type="text" value="Daffodil International University." readonly></div>
      <div class="sgap"></div>
      <div class="sec-head">üéì Submitted By</div>
      <div class="fg"><label>Your Name</label><input type="text" id="a_sName" placeholder="e.g. Imran Sifat" oninput="render()"></div>
      <div class="fg"><label>Student ID</label><input type="text" id="a_sId" placeholder="e.g. 241-15-001" oninput="render()"></div>
      <div class="fg"><label>Section</label><input type="text" id="a_sSec" placeholder="e.g. 66_I" oninput="render()"></div>
      <div class="fg"><label>Semester</label><input type="text" id="a_sSem" placeholder="e.g. Spring 2026" oninput="render()"></div>
      <div class="fg"><label>Department</label><input type="text" id="a_sDept" placeholder="e.g. CSE" oninput="render()"></div>
      <div class="fg"><label>University</label><input class="readonly-field" type="text" value="Daffodil International University." readonly></div>
      <div class="sgap"></div>
      <div class="sec-head">üìÖ Submission Date</div>
      <div class="fg"><label>Date</label><input type="date" id="a_subDate" oninput="render()"></div>
    </div>

    <!-- LAB REPORT PANEL -->
    <div class="mode-panel" id="panel-lab">
      <div class="sec-head">üìÑ Document Info</div>
      <div class="fg"><label>Experiment Name</label><input type="text" id="l_expName" placeholder="e.g. Study of Basic Logic Gates" oninput="render()"></div>
      <div class="fg"><label>Experiment No</label><input type="text" id="l_expNo" placeholder="e.g. 01" oninput="render()"></div>
      <div class="fg"><label>Course Code</label><input type="text" id="l_courseCode" placeholder="e.g. CSE311" oninput="render()"></div>
      <div class="fg"><label>Course Title</label><input type="text" id="l_courseTitle" placeholder="e.g. Database Management System" oninput="render()"></div>
      <div class="sgap"></div>
      <div class="sec-head-row">
        <div class="sec-head">üë®‚Äçüè´ Submitted To</div>
        <button class="copy-btn" onclick="copyFromAssignment()">‚ö° Copy from Assignment</button>
      </div>
      <div class="fg"><label>Teacher Name</label><input type="text" id="l_tName" placeholder="e.g. Grace Hopper, Tim Berners-Lee" oninput="render()"></div>
      <div class="optional-toggle" onclick="toggleOptional('l_optional_teacher')" id="opt-tog-l-teacher">
        <span class="optional-toggle-icon" id="opt-icon-l-teacher">‚ñ∂</span>
        <span class="optional-toggle-text">Teacher Designation (Optional)</span>
        <span class="optional-toggle-badge">+1</span>
      </div>
      <div class="optional-fields" id="l_optional_teacher">
        <div class="field-enable-row">
          <div class="fg fg-optional" id="fg-l_tDesignation">
            <label>Teacher Designation</label>
            <input type="text" id="l_tDesignation" placeholder="e.g. Lecturer, Asst. Professor" oninput="render()" disabled>
          </div>
          <button class="field-toggle-btn" id="toggle-l_tDesignation" onclick="toggleField('l_tDesignation')" title="Enable/Disable"></button>
        </div>
      </div>
      <div class="fg"><label>Department</label><input type="text" id="l_tDept" placeholder="e.g. CSE" oninput="render()"></div>
      <div class="fg"><label>University (Fixed)</label><input class="readonly-field" type="text" value="Daffodil International University." readonly></div>
      <div class="sgap"></div>
      <div class="sec-head">üéì Submitted By</div>
      <div class="fg"><label>Your Name</label><input type="text" id="l_sName" placeholder="e.g. Imran Sifat" oninput="render()"></div>
      <div class="fg"><label>Student ID</label><input type="text" id="l_sId" placeholder="e.g. 241-15-001" oninput="render()"></div>
      <div class="optional-toggle" onclick="toggleOptional('l_optional_student')" id="opt-tog-l-student">
        <span class="optional-toggle-icon" id="opt-icon-l-student">‚ñ∂</span>
        <span class="optional-toggle-text">Add Group No (Optional)</span>
        <span class="optional-toggle-badge">+1</span>
      </div>
      <div class="optional-fields" id="l_optional_student">
        <div class="field-enable-row">
          <div class="fg fg-optional" id="fg-l_groupNo">
            <label>Group No</label>
            <input type="text" id="l_groupNo" placeholder="e.g. Group 03" oninput="render()" disabled>
          </div>
          <button class="field-toggle-btn" id="toggle-l_groupNo" onclick="toggleField('l_groupNo')" title="Enable/Disable"></button>
        </div>
      </div>
      <div class="fg"><label>Section</label><input type="text" id="l_sSec" placeholder="e.g. 66_I" oninput="render()"></div>
      <div class="fg"><label>Semester</label><input type="text" id="l_sSem" placeholder="e.g. Spring 2026" oninput="render()"></div>
      <div class="fg"><label>Department</label><input type="text" id="l_sDept" placeholder="e.g. CSE" oninput="render()"></div>
      <div class="fg"><label>University</label><input class="readonly-field" type="text" value="Daffodil International University." readonly></div>
      <div class="sgap"></div>
      <div class="sec-head">üìÖ Submission Date</div>
      <div class="fg"><label>Date</label><input type="date" id="l_subDate" oninput="render()"></div>
    </div>

    <div style="position:relative;" class="dl-btn-wrap">
      <div class="dl-btn-tooltip" id="dlTooltip">Fill at least all but 2 fields to download</div>
      <button class="dl-btn" id="dlBtn" onclick="downloadPDF()" disabled>‚¨á &nbsp; DOWNLOAD PDF</button>
    </div>
    <div class="reset-bar" id="resetBarA" style="display:none">
      <button class="reset-btn" onclick="resetFields('assignment')">üóë Reset</button>
      <button class="undo-btn" id="undo-btn-assignment" onclick="undoReset('assignment')" disabled>
        ‚Ü© Undo <span id="undo-timer-assignment"></span>
        <div class="undo-timer" id="undo-bar-assignment" style="width:0%;height:3px;position:absolute;bottom:0;left:0;background:#f59e0b;border-radius:0 0 0 4px;"></div>
      </button>
    </div>
    <div class="reset-bar" id="resetBarL" style="display:none">
      <button class="reset-btn" onclick="resetFields('lab')">üóë Reset</button>
      <button class="undo-btn" id="undo-btn-lab" onclick="undoReset('lab')" disabled>
        ‚Ü© Undo <span id="undo-timer-lab"></span>
        <div class="undo-timer" id="undo-bar-lab" style="width:0%;height:3px;position:absolute;bottom:0;left:0;background:#f59e0b;border-radius:0 0 0 4px;"></div>
      </button>
    </div>
  </div>

  <div class="prev-panel">
    <div class="prev-label">LIVE PREVIEW ‚Äî COVER PAGE</div>
    <div id="cover-page" class="cv-page">
      <div class="cv-border"></div>
      <div class="cv-wm"></div>
      <div class="cv-body" id="cv-body"></div>
    </div>
    <div class="prev-label bottom-label">
      Developed by <strong>Sifatur Rahman Imran</strong> ¬∑ <span style="cursor:pointer;color:#a8c0ff;" onclick="openModal('devModal')">Contact</span>
    </div>
  </div>
</div>

<!-- MERGE PDF VIEW -->
<div class="merge-view" id="mergeView">
  <div class="merge-topbar">
    <div class="merge-topbar-left">
      <div class="merge-topbar-title">‚äï MERGE <span>PDF</span></div>
      <div class="merge-topbar-desc">Combine cover page with any PDF ¬∑ Drag to reorder ¬∑ Download as one file</div>
    </div>
    <div class="merge-steps" id="mergeSteps">
      <div class="merge-step" id="mstep1"><div class="ms-num">1</div><span>ADD FILES</span></div>
      <div class="merge-step" id="mstep2"><div class="ms-num">2</div><span>REORDER</span></div>
      <div class="merge-step" id="mstep3"><div class="ms-num">3</div><span>DOWNLOAD</span></div>
    </div>
    <div class="merge-topbar-right">
      <button class="add-cover-btn" id="addCoverBtn" onclick="addCoverToPile()">Ôºã ADD MY COVER PAGE</button>
    </div>
  </div>
  <div class="merge-dropzone-wrap">
    <div class="merge-dropzone" id="mergeDropzone">
      <input type="file" id="mergeFileInput" accept="application/pdf" multiple onchange="handleMergeFiles(this.files)">
      <div class="dz-icon">üìÇ</div>
      <div class="dz-text">Drop PDF files here, or click to browse</div>
      <div class="dz-sub">Multiple files supported ¬∑ Any PDF works</div>
    </div>
  </div>
  <div class="merge-cards-wrap">
    <div id="coverNoteWrap" style="display:none">
      <div class="cover-note">
        <span style="font-size:15px;flex-shrink:0">üü¢</span>
        <span>Your <strong>generated cover page</strong> has been added. Drag it or use arrows to reorder, then hit Download Merged PDF.</span>
      </div>
    </div>
    <div class="merge-cards-header">
      <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
        <span class="merge-cards-title">üìë PDF Queue</span>
        <span class="merge-cards-count" id="cardCount">0 files</span>
        <span class="drag-hint" id="dragHint" style="display:none">‚ò∞ Drag cards to reorder</span>
      </div>
      <button class="clear-btn" id="clearBtn" onclick="clearAll()" style="display:none">‚úï Clear All</button>
    </div>
    <div class="merge-cards" id="mergeCards">
      <div class="merge-empty" id="mergeEmpty">
        <div class="merge-empty-icon">üóÇÔ∏è</div>
        <div class="merge-empty-text">No PDFs yet</div>
        <div class="merge-empty-sub">Drop files above, or click "Add My Cover Page" to start</div>
      </div>
    </div>
  </div>
  <div class="merge-progress-wrap">
    <div class="merge-progress" id="mergeProgress">
      <div class="merge-progress-bar" id="mergeProgressBar"></div>
    </div>
  </div>
  <div class="merge-bottombar">
    <div class="merge-info" id="mergeInfo">Add at least 2 PDFs to merge</div>
    <button class="merge-dl-btn" id="mergeDlBtn" onclick="doMerge()" disabled>‚¨á &nbsp; DOWNLOAD MERGED PDF</button>
  </div>
</div>

<!-- MOBILE TAB BAR -->
<div class="mobile-tab-bar" id="mobileTabBar">
  <div class="mob-tabs">
    <button class="mob-tab active" id="mobtab-a" onclick="setMode('assignment')">
      <span class="mt-icon">üìÑ</span><span>ASSIGNMENT</span>
    </button>
    <button class="mob-tab" id="mobtab-l" onclick="setMode('lab')">
      <span class="mt-icon">üî¨</span><span>LAB REPORT</span>
    </button>
    <button class="mob-tab" id="mobtab-m" onclick="setMode('merge')">
      <span class="mt-icon">‚äï</span><span>MERGE</span>
    </button>
  </div>
</div>

<script>
if(window.pdfjsLib) pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

let mode='assignment';
let currentRating=0;
let lastModeBeforeMerge='assignment';
let coverChoiceSelected='assignment';

/* ‚îÄ‚îÄ TOAST SYSTEM ‚îÄ‚îÄ */
function showToast(type,title,msg,duration=4000){
  const icons={success:'‚úÖ',error:'‚ùå',info:'‚ÑπÔ∏è',warning:'‚ö†Ô∏è'};
  const container=document.getElementById('toast-container');
  const t=document.createElement('div');
  t.className=`toast ${type}`;
  t.style.position='relative';
  t.innerHTML=`<span class="toast-icon">${icons[type]||'üí¨'}</span>
    <div class="toast-body"><div class="toast-title">${title}</div>${msg?`<div class="toast-msg">${msg}</div>`:''}
    </div><button class="toast-close" onclick="dismissToast(this.parentElement)">√ó</button>`;
  container.appendChild(t);
  requestAnimationFrame(()=>{requestAnimationFrame(()=>{t.classList.add('show');});});
  const pid=setTimeout(()=>dismissToast(t),duration);
  t._pid=pid;
  return t;
}
function dismissToast(t){
  if(!t||!t.parentElement)return;
  clearTimeout(t._pid);
  t.classList.remove('show');t.classList.add('hide');
  setTimeout(()=>{if(t.parentElement)t.parentElement.removeChild(t);},400);
}

/* ‚îÄ‚îÄ WELCOME BANNER ‚îÄ‚îÄ */
const WELCOME_DURATION=8000;
let wbTimer=null,wbInterval=null;
function showWelcome(){
  setTimeout(()=>{
    const b=document.getElementById('welcomeBanner');
    b.classList.add('open');
    const bar=document.getElementById('wbBar');
    const secEl=document.getElementById('wbSec');
    bar.style.transition='none';bar.style.width='100%';
    bar.getBoundingClientRect();
    bar.style.transition='width '+WELCOME_DURATION+'ms linear';
    bar.style.width='0%';
    let rem=Math.floor(WELCOME_DURATION/1000);
    if(secEl) secEl.textContent=rem;
    wbInterval=setInterval(()=>{rem--;if(secEl)secEl.textContent=Math.max(0,rem);if(rem<=0){clearInterval(wbInterval);}},1000);
    wbTimer=setTimeout(closeWelcome,WELCOME_DURATION);
  },700);
}
function closeWelcome(){
  clearTimeout(wbTimer);clearInterval(wbInterval);
  const b=document.getElementById('welcomeBanner');
  b.style.transition='transform .4s cubic-bezier(.4,0,.2,1)';
  b.classList.remove('open');
}
showWelcome();

/* TEMPLATE MODAL */
function closeTplBg(e){if(e.target===document.getElementById('tplModal'))closeModal('tplModal');}

/* UNDO STATE */
const undoState={assignment:null,lab:null};
let undoTimerHandle={assignment:null,lab:null};
let undoIntervalHandle={assignment:null,lab:null};
const UNDO_SECONDS=15;

/* VISITOR COUNTER */
(function(){
  try{
    const KEY='diu_cover_craft_visitors';
    let c=parseInt(localStorage.getItem(KEY)||'0',10);c++;localStorage.setItem(KEY,c);
    const el=document.getElementById('visitorCount');
    if(el){let s=Math.max(0,c-8);const t=()=>{if(s<=c){el.textContent=s;s++;setTimeout(t,60);}};t();}
  }catch(e){try{document.getElementById('visitorCount').textContent='‚Äî';}catch(_){}}
})();

/* DOWNLOAD COUNTER */
(function(){
  try{
    const KEY='diu_cover_craft_downloads';
    let c=parseInt(localStorage.getItem(KEY)||'0',10);
    const el=document.getElementById('dlCount');
    if(el){let s=Math.max(0,c-5);const t=()=>{if(s<=c){el.textContent=s;s++;setTimeout(t,70);}};t();}
  }catch(e){try{document.getElementById('dlCount').textContent='‚Äî';}catch(_){}}
})();
function incrementDownloadCount(){
  try{
    const KEY='diu_cover_craft_downloads';
    let c=parseInt(localStorage.getItem(KEY)||'0',10);c++;localStorage.setItem(KEY,c);
    const el=document.getElementById('dlCount');if(el)el.textContent=c;
  }catch(e){}
}

/* OPTIONAL FIELDS TOGGLE */
function toggleOptional(groupId){
  const el=document.getElementById(groupId);
  const isOpen=el.classList.contains('open');
  const iconMap={'a_optional_doc':'opt-icon-a-doc','a_optional_teacher':'opt-icon-a-teacher','l_optional_teacher':'opt-icon-l-teacher','l_optional_student':'opt-icon-l-student'};
  const iconEl=document.getElementById(iconMap[groupId]);
  if(isOpen){el.classList.remove('open');if(iconEl)iconEl.classList.remove('open');}
  else{el.classList.add('open');if(iconEl)iconEl.classList.add('open');}
}
function toggleField(fieldId){
  const inp=document.getElementById(fieldId);
  const fg=document.getElementById('fg-'+fieldId);
  const btn=document.getElementById('toggle-'+fieldId);
  if(!inp||!fg||!btn)return;
  const enabling=inp.disabled;
  inp.disabled=!enabling;
  fg.classList.toggle('fg-optional',!enabling);
  fg.classList.toggle('enabled',enabling);
  btn.classList.toggle('on',enabling);
  if(enabling) inp.focus();
  render();
}

/* FIELD VALIDATION */
const REQUIRED_FIELDS={
  assignment:['a_topicName','a_courseCode','a_courseTitle','a_tName','a_tDept','a_sName','a_sId','a_sSec','a_sSem','a_sDept','a_subDate'],
  lab:['l_expName','l_expNo','l_courseCode','l_courseTitle','l_tName','l_tDept','l_sName','l_sId','l_sSec','l_sSem','l_sDept','l_subDate']
};
function checkFields(){
  if(mode==='merge')return;
  const fields=REQUIRED_FIELDS[mode];
  let empty=0;
  fields.forEach(id=>{const el=document.getElementById(id);if(!el||!el.value.trim())empty++;});
  const btn=document.getElementById('dlBtn'),tip=document.getElementById('dlTooltip');
  const ok=empty<=2;btn.disabled=!ok;
  tip.textContent=ok?'':`Fill ${Math.max(0,empty-2)} more field${(empty-2)>1?'s':''} to enable download`;
  updateResetBarVisibility();
}
function updateResetBarVisibility(){
  document.getElementById('resetBarA').style.display=(mode==='assignment')?'flex':'none';
  document.getElementById('resetBarL').style.display=(mode==='lab')?'flex':'none';
}
function countFilledFields(modeKey){
  return REQUIRED_FIELDS[modeKey].filter(id=>{const el=document.getElementById(id);return el&&el.value.trim();}).length;
}

/* RESET + UNDO */
function captureSnapshot(modeKey){
  const snap={};REQUIRED_FIELDS[modeKey].forEach(id=>{const el=document.getElementById(id);if(el)snap[id]=el.value;});return snap;
}
function hasAnyData(modeKey){
  return REQUIRED_FIELDS[modeKey].some(id=>{const el=document.getElementById(id);return el&&el.value.trim();});
}
function resetFields(modeKey){
  if(!hasAnyData(modeKey)){showToast('warning','Nothing to reset','All fields are already empty.');return;}
  undoState[modeKey]=captureSnapshot(modeKey);
  REQUIRED_FIELDS[modeKey].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
  render();startUndoTimer(modeKey);
  showToast('warning','Fields cleared','Press Undo within 15s to restore.','3000');
}
function startUndoTimer(modeKey){
  const btn=document.getElementById('undo-btn-'+modeKey);
  const timerSpan=document.getElementById('undo-timer-'+modeKey);
  const bar=document.getElementById('undo-bar-'+modeKey);
  if(undoTimerHandle[modeKey])clearTimeout(undoTimerHandle[modeKey]);
  if(undoIntervalHandle[modeKey])clearInterval(undoIntervalHandle[modeKey]);
  btn.disabled=false;
  let remaining=UNDO_SECONDS;
  timerSpan.textContent='('+remaining+'s)';
  bar.style.transition='none';bar.style.width='100%';
  bar.getBoundingClientRect();
  bar.style.transition='width '+UNDO_SECONDS+'s linear';bar.style.width='0%';
  undoIntervalHandle[modeKey]=setInterval(()=>{remaining--;if(timerSpan)timerSpan.textContent='('+remaining+'s)';if(remaining<=0){clearInterval(undoIntervalHandle[modeKey]);undoIntervalHandle[modeKey]=null;}},1000);
  undoTimerHandle[modeKey]=setTimeout(()=>expireUndo(modeKey),UNDO_SECONDS*1000);
}
function expireUndo(modeKey){
  undoState[modeKey]=null;
  if(undoIntervalHandle[modeKey]){clearInterval(undoIntervalHandle[modeKey]);undoIntervalHandle[modeKey]=null;}
  const btn=document.getElementById('undo-btn-'+modeKey);
  const timerSpan=document.getElementById('undo-timer-'+modeKey);
  const bar=document.getElementById('undo-bar-'+modeKey);
  if(btn)btn.disabled=true;if(timerSpan)timerSpan.textContent='';if(bar){bar.style.transition='none';bar.style.width='0%';}
}
function undoReset(modeKey){
  if(!undoState[modeKey])return;
  const snap=undoState[modeKey];
  Object.keys(snap).forEach(id=>{const el=document.getElementById(id);if(el)el.value=snap[id];});
  render();
  if(undoTimerHandle[modeKey]){clearTimeout(undoTimerHandle[modeKey]);undoTimerHandle[modeKey]=null;}
  expireUndo(modeKey);
  showToast('success','Restored!','Your fields have been recovered.');
}

/* MODE SWITCHER */
function setMode(m){
  if(m!=='merge')lastModeBeforeMerge=m;
  mode=m;
  document.getElementById('btn-a').className='tbtn'+(m==='assignment'?' active':'');
  document.getElementById('btn-l').className='tbtn'+(m==='lab'?' active':'');
  document.getElementById('btn-m').className='tbtn merge-tab'+(m==='merge'?' active':'');
  document.getElementById('panel-assignment').className='mode-panel'+(m==='assignment'?' active':'');
  document.getElementById('panel-lab').className='mode-panel'+(m==='lab'?' active':'');
  document.getElementById('mainLayout').style.display=m==='merge'?'none':'grid';
  document.getElementById('mergeView').className='merge-view'+(m==='merge'?' active':'');
  document.querySelectorAll('.mob-tab').forEach(t=>t.classList.remove('active'));
  if(m==='assignment')document.getElementById('mobtab-a').classList.add('active');
  else if(m==='lab')document.getElementById('mobtab-l').classList.add('active');
  else if(m==='merge')document.getElementById('mobtab-m').classList.add('active');
  if(m!=='merge'){document.getElementById('mobileToggleLabel').textContent=m==='assignment'?'Switch to Lab Report':'Switch to Assignment';render();}
  updateResetBarVisibility();updateMergeSteps();
}
function updateMergeSteps(){
  if(mode!=='merge')return;
  const hasFiles=mergeItems.length>0;const canDl=mergeItems.length>=2;
  document.getElementById('mstep1').className='merge-step'+(hasFiles?' done':' active-step');
  document.getElementById('mstep2').className='merge-step'+(canDl?' done':hasFiles?' active-step':'');
  document.getElementById('mstep3').className='merge-step'+(canDl?' active-step':'');
}
function toggleMenu(){
  const btn=document.getElementById('hamburgerBtn'),menu=document.getElementById('dropdownMenu');
  const o=menu.classList.contains('open');
  btn.classList.toggle('open',!o);menu.classList.toggle('open',!o);
  const mob=window.innerWidth<=700;
  document.getElementById('mobileModeSection').style.display=mob?'block':'none';
  document.getElementById('mobileToggleBtn').style.display=mob?'flex':'none';
}
function closeMenu(){document.getElementById('hamburgerBtn').classList.remove('open');document.getElementById('dropdownMenu').classList.remove('open');}
document.addEventListener('click',e=>{
  const menu=document.getElementById('dropdownMenu'),btn=document.getElementById('hamburgerBtn');
  if(menu.classList.contains('open')&&!menu.contains(e.target)&&!btn.contains(e.target))closeMenu();
});
function toggleModeFromMenu(){setMode(mode==='assignment'||mode==='merge'?'lab':'assignment');closeMenu();}
function openModal(id){closeMenu();document.getElementById(id).classList.add('open');}
function closeModal(id){document.getElementById(id).classList.remove('open');}
function closeBg(e,id){if(e.target===document.getElementById(id))closeModal(id);}

const ratingLabels=['','Awful üòû','Not great üòï','OK üòê','Good üòä','Excellent! üéâ'];
function setRating(v){
  currentRating=v;
  document.querySelectorAll('.star').forEach(s=>s.classList.toggle('active',parseInt(s.dataset.v)<=v));
  document.getElementById('ratingLabel').textContent=ratingLabels[v];
}
function submitRating(){
  if(!currentRating){document.getElementById('ratingLabel').textContent='‚ö†Ô∏è Please select a rating first';return;}
  document.getElementById('submitSuccess').style.display='block';
  showToast('success','Thanks for your feedback!','Your rating has been submitted.');
  setTimeout(()=>{closeModal('ratingModal');document.getElementById('submitSuccess').style.display='none';document.getElementById('commentBox').value='';currentRating=0;setRating(0);},2000);
}
function copyFromAssignment(){
  ['courseCode','courseTitle','tName','tDept','sName','sId','sSec','sSem','sDept','subDate'].forEach(f=>{
    const src=document.getElementById('a_'+f),dst=document.getElementById('l_'+f);if(src&&dst)dst.value=src.value;
  });
  render();showToast('success','Copied!','Assignment fields copied to Lab Report.');
}

function g(id){const e=document.getElementById(id);return e?e.value.trim():'';}
function gmFor(modeKey,f){return g((modeKey==='assignment'?'a_':'l_')+f);}
function fd(s){
  if(!s)return'';
  const d=new Date(s+'T12:00:00');
  return String(d.getDate()).padStart(2,'0')+'/'+String(d.getMonth()+1).padStart(2,'0')+'/'+d.getFullYear();
}
function isFieldEnabled(id){const el=document.getElementById(id);return el&&!el.disabled&&el.value.trim();}
function row(l,v){return`<div class="cv-row"><span class="cv-lbl">${l} </span><span class="cv-val">${v||''}</span></div>`;}
function irow(l,v,b=false){return`<div class="cv-ir"><span class="cv-il">${l} </span><span class="cv-iv${b?' cv-iv-name':''}">${v||''}</span></div>`;}

function buildHTMLForMode(modeKey){
  const isLab=modeKey==='lab';
  const get=(f)=>gmFor(modeKey,f);
  const getOptional=(f)=>{
    const id=(isLab?'l_':'a_')+f;
    const el=document.getElementById(id);
    return(el&&!el.disabled)?el.value.trim():'';
  };
  let h='';
  h+=`<div class="cv-logo"><img src="img/DIU-Logo.png" alt="DIU" onerror="this.style.display='none'"></div>`;
  h+=`<div class="cv-title">${isLab?'LAB REPORT':'Assignment'}</div>`;
  if(!isLab){
    const assignNo=getOptional('assignmentNo');
    if(assignNo) h+=row('Assignment No:',assignNo);
    h+=row('Topic Name:',get('topicName'));
  }else{
    h+=row('Experiment Name:',get('expName'));
    h+=row('Experiment No:',get('expNo'));
  }
  h+=row('Course Code:',get('courseCode'));
  h+=row('Course Title:',get('courseTitle'));
  const tDesig=getOptional('tDesignation');
  h+=`<div class="cv-sec"><u>Submitted To</u>:</div><div class="cv-ib">
    ${irow('Teacher Name:',get('tName'),true)}
    ${tDesig?irow('Designation:',tDesig):''}
    ${irow('Department:',get('tDept'))}
    <div class="cv-uline">Daffodil International University.</div>
  </div>`;
  const groupNo=isLab?getOptional('groupNo'):'';
  h+=`<div class="cv-sec"><u>Submitted By</u>:</div><div class="cv-ib">
    ${irow('Name:',get('sName'),true)}
    ${irow('ID:',get('sId'))}
    ${isLab&&groupNo?irow('Group No:',groupNo):''}
    ${irow('Section:',get('sSec'))}
    ${irow('Semester:',get('sSem'))}
    ${irow('Department:',get('sDept'))}
    <div class="cv-uline">Daffodil International University.</div>
  </div>`;
  h+=`<div style="height:26px"></div>`;
  h+=`<div class="cv-date-row"><span class="cv-lbl"><u>Submission Date</u>: </span><span class="cv-val">${fd(get('subDate'))}</span></div>`;
  return h;
}
function buildHTML(){return buildHTMLForMode(mode==='merge'?lastModeBeforeMerge:mode);}
function render(){document.getElementById('cv-body').innerHTML=buildHTML();checkFields();}

/* Particle burst */
function triggerParticleBurst(btn){
  const rect=btn.getBoundingClientRect();const cx=rect.left+rect.width/2;const cy=rect.top+rect.height/2;
  const overlay=document.createElement('div');overlay.className='dl-particles';document.body.appendChild(overlay);
  const colors=['#4ade80','#2d54b8','#a8c0ff','#7c3aed','#fbbf24','#f472b6','#38bdf8','#fb923c'];
  for(let i=0;i<22;i++){
    const p=document.createElement('div');p.className='dl-particle';
    const angle=(Math.PI*2/22)*i;const dist=50+Math.random()*100;const size=6+Math.random()*8;
    p.style.cssText=`left:${cx}px;top:${cy}px;width:${size}px;height:${size}px;background:${colors[i%colors.length]};--tx:${Math.cos(angle)*dist}px;--ty:${Math.sin(angle)*dist}px;animation-duration:${0.5+Math.random()*0.5}s;`;
    overlay.appendChild(p);
  }
  setTimeout(()=>{if(overlay.parentNode)overlay.parentNode.removeChild(overlay);},1400);
}

/* Universal download */
function universalDownload(blob,filename){
  try{
    if(window.navigator&&window.navigator.msSaveOrOpenBlob){window.navigator.msSaveOrOpenBlob(blob,filename);return;}
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');a.href=url;a.download=filename;a.style.display='none';
    document.body.appendChild(a);a.click();
    setTimeout(()=>{document.body.removeChild(a);URL.revokeObjectURL(url);},500);
    setTimeout(()=>{showToast('success','PDF Downloaded!','Check your downloads folder.',5000);},800);
    return;
  }catch(e1){}
  try{
    const url=URL.createObjectURL(blob);
    const opened=window.open(url,'_blank');
    setTimeout(()=>URL.revokeObjectURL(url),15000);
    if(!opened||opened.closed){blobToDataURIDownload(blob,filename);}
    else{showToast('info','PDF Opened','Save it from the new tab/window.',5000);}
    return;
  }catch(e2){}
  blobToDataURIDownload(blob,filename);
}
function blobToDataURIDownload(blob,filename){
  const r=new FileReader();
  r.onload=function(){
    const dataURI=r.result;
    try{const a=document.createElement('a');a.href=dataURI;a.download=filename;a.style.display='none';document.body.appendChild(a);a.click();document.body.removeChild(a);showToast('success','PDF Ready','If it didn\'t save, open in Chrome or Firefox.',6000);return;}catch(e){}
    try{window.open(dataURI,'_blank');}catch(e){}
    showToast('warning','Download Issue','Please open this page in Chrome or Firefox for best results.',8000);
  };
  r.onerror=()=>{showToast('error','Download Failed','Please open in Chrome or Firefox.',8000);};
  r.readAsDataURL(blob);
}
async function toDataURL(url){
  try{const res=await fetch(url,{mode:'cors'});const blob=await res.blob();return await new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>res(r.result);r.onerror=rej;r.readAsDataURL(blob);});}catch(e){return null;}
}

async function buildCoverPDFBlobForMode(modeKey){
  const wrapper=document.createElement('div');
  wrapper.style.cssText='position:absolute;top:0;left:0;width:793px;height:1122px;overflow:hidden;visibility:hidden;pointer-events:none;z-index:-9999;';
  wrapper.innerHTML=`
    <div id="pci" style="width:793px;height:1122px;background:#fff;position:relative;font-family:'Calibri','Carlito',Arial,sans-serif;color:#000;">
      <div style="position:absolute;top:16px;left:22px;right:22px;bottom:16px;border:1.5px solid #444;z-index:10;margin-right:2px;"></div>
      <div id="pwm" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:420px;height:420px;background-image:url('img/watermark.jpg');background-size:contain;background-repeat:no-repeat;background-position:center;opacity:0.075;z-index:1;"></div>
      <div style="position:relative;z-index:5;padding:36px 55px 40px 55px;display:flex;flex-direction:column;">${buildHTMLForMode(modeKey)}</div>
    </div>`;
  document.body.appendChild(wrapper);
  const cl=wrapper.querySelector('#pci');
  const st=document.createElement('style');
  st.textContent='.cv-iv-name{font-size:23px!important;font-weight:400!important;position:relative;top:2px;}';
  cl.appendChild(st);
  try{const lg=cl.querySelector('.cv-logo img');if(lg&&lg.src&&!lg.src.startsWith('data:')){const d=await toDataURL(lg.src);if(d)lg.src=d;}}catch(e){}
  try{const wm=cl.querySelector('#pwm');if(wm){const bg=wm.style.backgroundImage;const m=bg.match(/url\(['"]?(.*?)['"]?\)/);if(m&&m[1]&&!m[1].startsWith('data:')){const d=await toDataURL(m[1]);if(d)wm.style.backgroundImage=`url(${d})`;}}}catch(e){}
  await new Promise(r=>setTimeout(r,80));
  const opt={margin:0,image:{type:'jpeg',quality:1},html2canvas:{scale:3,useCORS:true,allowTaint:true,logging:false,width:794,height:1122,scrollX:0,scrollY:0},jsPDF:{unit:'mm',format:'a4',orientation:'portrait'}};
  const blob=await html2pdf().set(opt).from(cl).outputPdf('blob');
  document.body.removeChild(wrapper);
  return blob;
}

async function downloadPDF(){
  const btn=document.getElementById('dlBtn');
  if(btn.disabled)return;
  btn.classList.add('generating');
  btn.innerHTML='<span style="display:inline-block;animation:spin 1s linear infinite;margin-right:8px">‚è≥</span> GENERATING...';
  btn.disabled=true;
  try{
    const modeKey=mode==='merge'?lastModeBeforeMerge:mode;
    const blob=await buildCoverPDFBlobForMode(modeKey);
    btn.classList.remove('generating');btn.classList.add('success');
    const fname=(modeKey==='lab'?'Lab_Report_Cover-diucoverpoint':'Assignment_Cover_Page-diucoverpoint')+'.pdf';
    triggerParticleBurst(btn);
    universalDownload(blob,fname);
    incrementDownloadCount();
    btn.innerHTML='‚úÖ DOWNLOADED!';
    setTimeout(()=>{btn.classList.remove('success');btn.innerHTML='‚¨á &nbsp; DOWNLOAD PDF';checkFields();},2500);
  }catch(e){
    btn.classList.remove('generating');btn.innerHTML='‚¨á &nbsp; DOWNLOAD PDF';checkFields();
    showToast('error','Generation Failed','Could not create PDF. Try again or switch browser.',5000);
  }
}

/* ‚ïê‚ïê‚ïê MERGE LOGIC ‚ïê‚ïê‚ïê */
let mergeItems=[];let dragSrcIdx=null;
const mergeCardsEl=document.getElementById('mergeCards');
const mergeEmptyEl=document.getElementById('mergeEmpty');
const dz=document.getElementById('mergeDropzone');
['dragenter','dragover'].forEach(ev=>dz.addEventListener(ev,e=>{e.preventDefault();dz.classList.add('over');}));
dz.addEventListener('dragleave',()=>dz.classList.remove('over'));
dz.addEventListener('drop',e=>{
  e.preventDefault();dz.classList.remove('over');
  const files=[...e.dataTransfer.files].filter(f=>f.type==='application/pdf');
  if(files.length)handleMergeFiles(files);
});
function fmtSize(bytes){if(bytes<1024)return bytes+'B';if(bytes<1024*1024)return(bytes/1024).toFixed(1)+'KB';return(bytes/(1024*1024)).toFixed(1)+'MB';}

async function handleMergeFiles(files){
  for(const f of files){
    const bytes=new Uint8Array(await f.arrayBuffer());
    const id='f'+Date.now()+Math.random();let pageCount=1,thumb=null;
    try{
      const pdf=await pdfjsLib.getDocument({data:bytes.slice()}).promise;pageCount=pdf.numPages;
      const page=await pdf.getPage(1);const vp=page.getViewport({scale:0.42});
      const canvas=document.createElement('canvas');canvas.width=vp.width;canvas.height=vp.height;
      await page.render({canvasContext:canvas.getContext('2d'),viewport:vp}).promise;thumb=canvas;
    }catch(e){}
    mergeItems.push({id,name:f.name,bytes,pageCount,isCover:false,thumb,size:f.size});
  }
  document.getElementById('mergeFileInput').value='';
  renderMergeCards();updateMergeSteps();
  showToast('info','Files Added',`${files.length} PDF${files.length>1?'s':''} added to queue.`,3000);
}

function getCoverModeDecision(){
  const aC=countFilledFields('assignment');const lC=countFilledFields('lab');
  const aT=REQUIRED_FIELDS['assignment'].length;const lT=REQUIRED_FIELDS['lab'].length;
  if(aC===0&&lC===0)return null;if(aC>0&&lC===0)return'assignment';if(lC>0&&aC===0)return'lab';
  if(aC/aT>lC/lT)return'assignment';if(lC/lT>aC/aT)return'lab';return'equal';
}
function selectCoverChoice(choice){
  coverChoiceSelected=choice;
  document.getElementById('cco-assignment').classList.toggle('selected',choice==='assignment');
  document.getElementById('cco-lab').classList.toggle('selected',choice==='lab');
}
async function confirmCoverChoice(){closeModal('chooseCoverModal');await addCoverWithMode(coverChoiceSelected);}
async function addCoverToPile(){
  const decision=getCoverModeDecision();
  if(decision===null){showToast('warning','No Cover Data','Please fill in fields in the Assignment or Lab Report tab first.',5000);return;}
  if(decision==='equal'){
    const aC=countFilledFields('assignment');const lC=countFilledFields('lab');
    document.getElementById('cco-a-count').textContent=aC+' field'+(aC!==1?'s':'')+' filled';
    document.getElementById('cco-l-count').textContent=lC+' field'+(lC!==1?'s':'')+' filled';
    const aFields=REQUIRED_FIELDS['assignment'].filter(id=>{const e=document.getElementById(id);return e&&e.value.trim();}).map(id=>({a_topicName:'Topic',a_courseCode:'Code',a_courseTitle:'Title',a_tName:'Teacher',a_tDept:'Dept',a_sName:'Name',a_sId:'ID',a_sSec:'Section',a_sSem:'Semester',a_sDept:'S.Dept',a_subDate:'Date'}[id]||id)).join(', ');
    const lFields=REQUIRED_FIELDS['lab'].filter(id=>{const e=document.getElementById(id);return e&&e.value.trim();}).map(id=>({l_expName:'Exp Name',l_expNo:'Exp No',l_courseCode:'Code',l_courseTitle:'Title',l_tName:'Teacher',l_tDept:'Dept',l_sName:'Name',l_sId:'ID',l_sSec:'Section',l_sSem:'Semester',l_sDept:'S.Dept',l_subDate:'Date'}[id]||id)).join(', ');
    document.getElementById('cco-a-fields').textContent=aFields||'';
    document.getElementById('cco-l-fields').textContent=lFields||'';
    selectCoverChoice('assignment');openModal('chooseCoverModal');return;
  }
  await addCoverWithMode(decision);
}
async function addCoverWithMode(modeKey){
  mergeItems=mergeItems.filter(x=>!x.isCover);
  const btn=document.getElementById('addCoverBtn');
  btn.textContent='‚è≥ Generating...';btn.disabled=true;
  try{
    const blob=await buildCoverPDFBlobForMode(modeKey);
    const bytes=new Uint8Array(await blob.arrayBuffer());let thumb=null;
    try{
      const pdf=await pdfjsLib.getDocument({data:bytes.slice()}).promise;const page=await pdf.getPage(1);
      const vp=page.getViewport({scale:0.42});const canvas=document.createElement('canvas');
      canvas.width=vp.width;canvas.height=vp.height;
      await page.render({canvasContext:canvas.getContext('2d'),viewport:vp}).promise;thumb=canvas;
    }catch(e){}
    const label=modeKey==='lab'?'Lab Cover (Generated)':'Assignment Cover (Generated)';
    mergeItems.unshift({id:'cover',name:label,bytes,pageCount:1,isCover:true,thumb,size:blob.size});
    document.getElementById('coverNoteWrap').style.display='block';
    renderMergeCards();updateMergeSteps();
    showToast('success','Cover Added','Your cover page is ready in the queue.',3000);
  }catch(e){
    showToast('error','Cover Generation Failed','Fill in cover details first then try again.',5000);
  }
  btn.textContent='Ôºã ADD MY COVER PAGE';btn.disabled=false;
}

function renderMergeCards(){
  mergeCardsEl.innerHTML='';
  const total=mergeItems.reduce((a,x)=>a+x.pageCount,0);
  const totalSize=mergeItems.reduce((a,x)=>a+(x.size||0),0);
  const hasItems=mergeItems.length>0;
  document.getElementById('cardCount').textContent=mergeItems.length+' file'+(mergeItems.length!==1?'s':'');
  document.getElementById('mergeDlBtn').disabled=mergeItems.length<2;
  document.getElementById('clearBtn').style.display=hasItems?'':'none';
  document.getElementById('dragHint').style.display=mergeItems.length>1?'flex':'none';
  if(!hasItems){mergeCardsEl.appendChild(mergeEmptyEl);document.getElementById('coverNoteWrap').style.display='none';document.getElementById('mergeInfo').textContent='Add at least 2 PDFs to merge';return;}
  document.getElementById('mergeInfo').innerHTML=`<strong>${mergeItems.length} PDF${mergeItems.length!==1?'s':''}</strong> ¬∑ ${total} page${total!==1?'s':''} ¬∑ ${fmtSize(totalSize)}`;
  mergeItems.forEach((item,idx)=>{
    const card=document.createElement('div');card.className='pdf-card'+(item.isCover?' is-cover':'');card.draggable=true;card.dataset.idx=idx;
    const badge=document.createElement('div');badge.className='card-badge';badge.textContent=item.isCover?'COVER':'#'+(idx+1);card.appendChild(badge);
    const rm=document.createElement('button');rm.className='card-remove';rm.innerHTML='&times;';rm.title='Remove';
    rm.onclick=e=>{e.stopPropagation();mergeItems.splice(idx,1);if(item.isCover)document.getElementById('coverNoteWrap').style.display='none';renderMergeCards();updateMergeSteps();};
    card.appendChild(rm);
    const thumb=document.createElement('div');thumb.className='card-thumb';
    if(item.thumb){const c=item.thumb.cloneNode(true);c.style.cssText='width:100%;height:100%;object-fit:contain;display:block;';thumb.appendChild(c);}
    else{thumb.innerHTML='<div class="card-thumb-placeholder">üìÑ</div>';}
    card.appendChild(thumb);
    const info=document.createElement('div');info.className='card-info';
    info.innerHTML=`<div class="card-name" title="${item.name}">${item.name}</div><div class="card-meta"><span class="card-pages">${item.pageCount} pg${item.pageCount!==1?'s':''}</span><span class="card-size">${fmtSize(item.size||0)}</span></div>`;
    card.appendChild(info);
    const arrows=document.createElement('div');arrows.className='card-arrows';
    const lb=document.createElement('button');lb.className='arr-btn';lb.textContent='‚óÄ';lb.title='Move left';lb.disabled=idx===0;
    lb.onclick=e=>{e.stopPropagation();[mergeItems[idx-1],mergeItems[idx]]=[mergeItems[idx],mergeItems[idx-1]];renderMergeCards();updateMergeSteps();};
    const rb=document.createElement('button');rb.className='arr-btn';rb.textContent='‚ñ∂';rb.title='Move right';rb.disabled=idx===mergeItems.length-1;
    rb.onclick=e=>{e.stopPropagation();[mergeItems[idx],mergeItems[idx+1]]=[mergeItems[idx+1],mergeItems[idx]];renderMergeCards();updateMergeSteps();};
    arrows.appendChild(lb);arrows.appendChild(rb);card.appendChild(arrows);
    card.addEventListener('dragstart',e=>{dragSrcIdx=idx;card.classList.add('dragging');e.dataTransfer.effectAllowed='move';});
    card.addEventListener('dragend',()=>card.classList.remove('dragging'));
    card.addEventListener('dragover',e=>{e.preventDefault();card.classList.add('drag-over');});
    card.addEventListener('dragleave',()=>card.classList.remove('drag-over'));
    card.addEventListener('drop',e=>{e.preventDefault();card.classList.remove('drag-over');if(dragSrcIdx===null||dragSrcIdx===idx)return;const moved=mergeItems.splice(dragSrcIdx,1)[0];mergeItems.splice(idx,0,moved);dragSrcIdx=null;renderMergeCards();updateMergeSteps();});
    mergeCardsEl.appendChild(card);
  });
}

function clearAll(){
  mergeItems=[];renderMergeCards();updateMergeSteps();
  showToast('info','Queue Cleared','All PDFs removed from the merge queue.',3000);
}

async function doMerge(){
  if(mergeItems.length<2)return;
  const btn=document.getElementById('mergeDlBtn');
  btn.classList.add('generating');
  btn.innerHTML='<span style="display:inline-block;animation:spin 1s linear infinite;margin-right:6px">‚è≥</span> MERGING...';
  btn.disabled=true;
  const prog=document.getElementById('mergeProgress');const bar=document.getElementById('mergeProgressBar');
  prog.classList.add('show');bar.style.width='0%';
  try{
    const{PDFDocument}=PDFLib;const merged=await PDFDocument.create();
    for(let i=0;i<mergeItems.length;i++){
      bar.style.width=Math.round((i/mergeItems.length)*88)+'%';
      const src=await PDFDocument.load(mergeItems[i].bytes);
      const pages=await merged.copyPages(src,src.getPageIndices());
      pages.forEach(p=>merged.addPage(p));
    }
    bar.style.width='96%';const out=await merged.save();bar.style.width='100%';
    const blob=new Blob([out],{type:'application/pdf'});
    btn.classList.remove('generating');btn.classList.add('success');
    triggerParticleBurst(btn);
    universalDownload(blob,'DIU_Merged_Document-diucoverpoint.pdf');
    incrementDownloadCount();
    btn.innerHTML='‚úÖ DOWNLOADED!';
    setTimeout(()=>{btn.classList.remove('success');btn.innerHTML='‚¨á &nbsp; DOWNLOAD MERGED PDF';btn.disabled=mergeItems.length<2;prog.classList.remove('show');bar.style.width='0%';},2500);
  }catch(err){
    btn.classList.remove('generating');
    showToast('error','Merge Failed','Make sure PDFs are valid and not password-protected.',6000);
    btn.innerHTML='‚¨á &nbsp; DOWNLOAD MERGED PDF';btn.disabled=false;prog.classList.remove('show');
  }
}

// Initialize
render();
updateResetBarVisibility();
</script>
</body>
</html>